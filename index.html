<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Nh·∫∑t ƒê·ªìng Nh·ªè - V√≠ MoMo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#A50064">
<!-- Preload critical resources -->
<link rel="preload" href="assets/road.png" as="image">
<link rel="preload" href="assets/cotam-run.png" as="image">
<link rel="preload" href="assets/coin.png" as="image">

<style>
/* MINIFIED CSS - REMOVED ALL COMMENTS AND WHITESPACE */
:root{--vh:1vh}*{box-sizing:border-box;margin:0;padding:0}body{margin:0;padding:0;background:#000;overflow:hidden;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh;min-height:calc(var(--vh, 1vh) * 100);background:linear-gradient(135deg,#1a0033 0%,#330066 50%,#4d0099 100%);position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;height:calc(var(--vh, 1vh) * 100);-webkit-tap-highlight-color:transparent;touch-action:none;-webkit-user-select:none;user-select:none}
#gameWrapper{position:relative;width:100%;height:100%;max-width:360px;max-height:640px;margin:auto;transform-origin:center center;filter:drop-shadow(0 10px 30px rgba(0,0,0,0.5));touch-action:manipulation;overflow:hidden;display:flex;align-items:center;justify-content:center}
#start{position:absolute;top:0;left:0;width:100%;height:100%;z-index:50;cursor:pointer;background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden}
#start img{width:100%;height:100%;object-fit:cover;pointer-events:none;display:block;margin:auto;max-width:100%;max-height:100%}
#instruction{position:absolute;top:0;left:0;width:100%;height:100%;color:#fff;display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px;z-index:40;text-align:center;background:linear-gradient(-45deg,#A50064,#D6006E,#FF0077,#FF3399,#A50064,#D6006E,#FF0077,#FF3399);background-size:400% 400%;animation:gradientFlow 8s ease infinite}
@keyframes gradientFlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
#instructionBox{background:rgba(255,255,255,0.15);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:2px solid rgba(255,255,255,0.25);padding:30px;border-radius:25px;max-width:320px;width:90%;box-shadow:0 20px 40px rgba(0,0,0,0.3),inset 0 0 0 1px rgba(255,255,255,0.1)}
#instructionBox h2{margin-top:0;color:#fff;font-size:28px;text-shadow:0 2px 10px rgba(0,0,0,0.3);margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid rgba(255,255,255,0.3);position:relative}
#instructionBox h2::after{content:'';position:absolute;bottom:-2px;left:50%;transform:translateX(-50%);width:100px;height:3px;background:linear-gradient(90deg,transparent,#FFD700,transparent)}
#instructionBox ul{text-align:left;padding-left:25px;line-height:1.7;color:#fff;font-size:16px;margin-bottom:25px;list-style:none}
#instructionBox li{margin-bottom:16px;padding-left:35px;position:relative}
#instructionBox li::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:24px;height:24px;background:rgba(255,215,0,0.2);border-radius:50%;border:2px solid #FFD700}
#instructionBox li::after{content:'‚úì';position:absolute;left:0;top:50%;transform:translateY(-50%);width:24px;height:24px;color:#FFD700;font-weight:bold;text-align:center;line-height:24px}
#instructionBox b{color:#FFD700;font-weight:800;text-shadow:0 0 10px rgba(255,215,0,0.5)}
#hud{position:absolute;top:20px;left:20px;color:#fff;font-weight:bold;z-index:10;background:rgba(165,0,100,0.85);padding:15px 20px;border-radius:20px;border:2px solid rgba(255,215,0,0.3);box-shadow:0 10px 20px rgba(0,0,0,0.3);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
.hud-item{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.hud-item:last-child{margin-bottom:0}
.hud-icon{font-size:24px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.hud-value{font-size:24px;color:#FFD700;text-shadow:0 0 10px rgba(255,215,0,0.5)}
#soundBtn{position:absolute;top:20px;right:20px;width:44px;height:44px;background:rgba(165,0,100,0.85);border-radius:50%;border:2px solid rgba(255,215,0,0.3);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:11;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);box-shadow:0 5px 15px rgba(0,0,0,0.3);transition:all 0.3s ease}
#soundBtn:hover{transform:scale(1.1)}
#soundIcon{font-size:22px;color:#FFD700;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
#progressBox{position:absolute;top:145px;left:20px;width:200px;height:16px;background:rgba(255,255,255,0.1);border-radius:10px;overflow:hidden;border:2px solid rgba(255,255,255,0.2);box-shadow:0 5px 15px rgba(0,0,0,0.2)}
#progress{height:100%;width:0%;background:linear-gradient(90deg,#FFD700 0%,#FFB300 25%,#FF9100 50%,#FFB300 75%,#FFD700 100%);background-size:200% 100%;animation:progressShine 2s linear infinite;box-shadow:0 0 20px rgba(255,215,0,0.7),inset 0 0 40px rgba(255,215,0,0.3);transition:width 0.3s ease}
canvas{display:block;width:100%;height:100%;border-radius:20px;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,0.4),inset 0 0 0 2px rgba(255,215,0,0.2);-webkit-touch-callout:none}
.btn-momo{margin-top:20px;padding:16px 36px;border:none;border-radius:25px;font-size:18px;font-weight:800;background:linear-gradient(135deg,#FFD700 0%,#FFB300 50%,#FF9100 100%);color:#A50064;cursor:pointer;transition:all 0.3s ease;box-shadow:0 10px 25px rgba(165,0,100,0.4);font-family:inherit;letter-spacing:0.5px;position:relative;overflow:hidden;z-index:1;-webkit-appearance:none}
.btn-momo::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.4),transparent);transition:0.6s;z-index:-1}
.btn-momo:hover{transform:translateY(-5px) scale(1.05);box-shadow:0 15px 35px rgba(165,0,100,0.6)}
.btn-momo:hover::before{left:100%}
.btn-momo:active{transform:translateY(2px) scale(1)}
#but{position:absolute;top:-200px;left:50%;transform:translateX(-50%);width:140px;opacity:0;transition:all 0.8s cubic-bezier(0.68,-0.55,0.265,1.55);z-index:15;filter:drop-shadow(0 10px 20px rgba(0,0,0,0.4));pointer-events:none}
#but.show{top:100px;opacity:1;transform:translateX(-50%) scale(1.1);animation:butFloat 3s ease-in-out infinite}
#but.hide{animation:butHide 0.5s ease forwards}
#basketDrop{position:absolute;top:200px;left:50%;transform:translateX(-50%) scale(0);width:80px;opacity:0;z-index:16;pointer-events:none;filter:drop-shadow(0 10px 20px rgba(255,215,0,0.5));transition:opacity 0.6s cubic-bezier(0.2,0.8,0.3,1),transform 0.6s cubic-bezier(0.2,0.8,0.3,1)}
#basketDrop.show{opacity:1;transform:translateX(-50%) scale(1);animation:basketBounce 0.6s ease}
#over{position:absolute;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:flex-start;flex-direction:column;color:#fff;z-index:50;padding:30px;text-align:center;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);overflow-y:auto;padding-bottom:100px;-webkit-overflow-scrolling:touch;background:linear-gradient(-45deg,rgba(165,0,100,0.95),rgba(214,0,110,0.95),rgba(255,0,119,0.95),rgba(255,51,153,0.95),rgba(165,0,100,0.95),rgba(214,0,110,0.95),rgba(255,0,119,0.95),rgba(255,51,153,0.95));background-size:400% 400%;animation:gradientFlow 8s ease infinite}
#over-content{display:flex;flex-direction:column;align-items:center;width:100%;max-width:340px;margin:0 auto}
#summary{background:rgba(255,255,255,0.15);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);padding:25px;border-radius:25px;width:100%;margin-bottom:20px;text-align:center;border:2px solid rgba(255,255,255,0.25);box-shadow:0 20px 40px rgba(0,0,0,0.3)}
.summary-item{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.2)}
.summary-item:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none}
.summary-value{font-size:24px;font-weight:bold;color:#FFD700;text-shadow:0 0 10px rgba(255,215,0,0.5)}
#voucherPopup{display:none;background:linear-gradient(135deg,#FFD700 0%,#FFB300 100%);color:#A50064;padding:25px;border-radius:25px;width:100%;margin-bottom:20px;text-align:center;border:3px solid rgba(255,255,255,0.7);box-shadow:0 20px 40px rgba(0,0,0,0.4),0 0 50px rgba(255,215,0,0.5);position:relative;overflow:hidden}
#voucherPopup::before{content:'';position:absolute;top:-10px;left:-10px;right:-10px;bottom:-10px;background:conic-gradient(from 0deg,#FFD700,#FF9100,#FFD700,#FF9100,#FFD700);z-index:-1;filter:blur(20px);opacity:0.5}
#voucherPopup h3{margin-top:0;color:#A50064;font-size:26px;margin-bottom:15px}
.voucher-image-container{width:100%;height:220px;margin:15px 0;border-radius:15px;overflow:hidden;box-shadow:0 10px 25px rgba(165,0,100,0.4);border:3px solid rgba(255,255,255,0.8);position:relative;background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center}
.voucher-image{width:100%;height:100%;object-fit:cover;display:block;position:absolute;top:0;left:0}
.voucher-code{font-size:28px;font-weight:900;letter-spacing:3px;background:rgba(255,255,255,0.95);padding:15px;border-radius:15px;margin:15px 0;color:#A50064;border:3px dashed #A50064;font-family:'Courier New',monospace;text-shadow:0 2px 4px rgba(0,0,0,0.1);animation:codePulse 2s ease-in-out infinite}
.voucher-desc{font-size:14px;margin-top:10px;color:#A50064;font-weight:bold}
.voucher-brand{font-size:20px;font-weight:900;margin:10px 0;text-transform:uppercase;letter-spacing:1px}
.voucher-value{font-size:24px;font-weight:900;color:#A50064;margin:10px 0;background:rgba(255,255,255,0.9);padding:8px 15px;border-radius:10px;display:inline-block}
#nameBox{background:rgba(255,255,255,0.15);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);padding:25px;border-radius:25px;width:100%;margin-bottom:20px;text-align:center;border:2px solid rgba(255,255,255,0.25);box-shadow:0 20px 40px rgba(0,0,0,0.3)}
#nameBox label{display:block;margin-bottom:10px;color:#FFD700;font-weight:bold;font-size:18px}
#playerName{width:100%;padding:15px;border-radius:15px;border:2px solid rgba(255,215,0,0.5);background:rgba(255,255,255,0.9);margin:10px 0 20px;font-size:16px;color:#A50064;font-weight:bold;text-align:center;-webkit-appearance:none}
#leaderboard{display:none;background:rgba(255,255,255,0.95);color:#A50064;border-radius:25px;width:100%;padding:25px;margin:20px 0;border:3px solid #FFD700;box-shadow:0 20px 40px rgba(0,0,0,0.3)}
#leaderboard h3{margin-top:0;color:#A50064;text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid rgba(165,0,100,0.3);font-size:24px}
.rank{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;margin:8px 0;border-radius:12px;background:rgba(255,215,0,0.1);border-left:5px solid transparent}
.rank.you{font-weight:bold;color:#FF9100;background:rgba(255,215,0,0.3);border-left:5px solid #FFD700}
.rank-medal{font-size:20px;margin-right:10px}
#playAgainBtn{margin-top:20px;margin-bottom:10px;position:relative;z-index:10;width:100%;max-width:340px}
@keyframes progressShine{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes butFloat{0%,100%{transform:translateX(-50%) translateY(0) scale(1.1)}50%{transform:translateX(-50%) translateY(-10px) scale(1.15)}}
@keyframes butHide{0%{transform:translateX(-50%) translateY(0) scale(1.1);opacity:1}100%{transform:translateX(-50%) translateY(-100px) scale(0.5);opacity:0}}
@keyframes basketBounce{0%{transform:translateX(-50%) scale(0)}60%{transform:translateX(-50%) scale(1.2)}100%{transform:translateX(-50%) scale(1)}}
@keyframes codePulse{0%,100%{transform:scale(1);box-shadow:0 0 20px rgba(255,215,0,0.5)}50%{transform:scale(1.05);box-shadow:0 0 40px rgba(255,215,0,0.8)}}
@keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-5px)}20%,40%,60%,80%{transform:translateX(5px)}}
@keyframes sparkle{0%{transform:translateY(0) rotate(0deg);opacity:0}50%{opacity:1}100%{transform:translateY(-100px) rotate(360deg);opacity:0}}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes shine{0%{background-position:-200% center}100%{background-position:200% center}}
.player-shadow{position:absolute;bottom:505px;left:50%;transform:translateX(-50%);width:60px;height:20px;background:rgba(0,0,0,0.3);border-radius:50%;filter:blur(5px);z-index:5;pointer-events:none}
@media (max-height:500px) and (orientation:landscape){#gameWrapper{max-height:500px;transform:scale(0.8)}#hud{transform:scale(0.8);transform-origin:top left}#soundBtn{transform:scale(0.8);transform-origin:top right}#progressBox{transform:scale(0.8);transform-origin:top left}.voucher-image-container{height:140px}.voucher-code{font-size:20px;padding:10px}.voucher-brand{font-size:16px}.voucher-value{font-size:18px}}
@supports (-webkit-touch-callout:none){body{height:-webkit-fill-available}#gameWrapper{height:-webkit-fill-available}}
@supports (padding:max(0px)){#gameWrapper{padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}#over{padding-top:calc(env(safe-area-inset-top) + 30px);padding-bottom:calc(env(safe-area-inset-bottom) + 100px)}#soundBtn{top:calc(env(safe-area-inset-top) + 20px);right:calc(env(safe-area-inset-right) + 20px)}}
html{-webkit-text-size-adjust:100%;text-size-adjust:100%;height:100%;overflow:hidden}
#start{background:#000}#start img{max-width:100%;max-height:100%;object-fit:cover;display:block;margin:auto}
@media (max-width:360px){#gameWrapper{max-width:100vw;max-height:calc(100vw * (640/360))}.voucher-image-container{height:180px}.voucher-code{font-size:22px;padding:12px}.voucher-brand{font-size:18px}.voucher-value{font-size:20px}}
@media (max-height:640px){#gameWrapper{max-height:100vh;max-width:calc(100vh * (360/640))}.voucher-image-container{height:180px}}
@media (max-width:320px){.voucher-image-container{height:160px}.voucher-code{font-size:20px;padding:10px}.voucher-brand{font-size:16px}.voucher-value{font-size:18px}}
@media (min-width:361px) and (min-height:641px){.voucher-image-container{height:240px}}
</style>

<!-- Inline critical CSS for faster rendering -->
<style id="critical-css">
/* Critical above-the-fold styles */
#gameWrapper{background:#000}
#start{background:#000;display:flex}
</style>
</head>

<body>

<div id="gameWrapper">

<!-- START SCREEN - Simplified -->
<div id="start" onclick="showInstruction()">
 <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzYwIiBoZWlnaHQ9IjY0MCIgdmlld0JveD0iMCAwIDM2MCA2NDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjM2MCIgaGVpZ2h0PSI2NDAiIGZpbGw9IiNBMDAwNjQiLz48dGV4dCB4PSIxODAiIHk9IjMyMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjMyIiBmaWxsPSIjRkZGRkZGIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXdlaWdodD0iYm9sZCI+TUVNRSBHTU1FPC90ZXh0Pjwvc3ZnPg==" alt="MoMo Game" id="startImage" onload="this.src='assets/start.png'">
</div>

<!-- N√öT √ÇM THANH -->
<div id="soundBtn" onclick="toggleSound()">
 <span id="soundIcon">üîä</span>
</div>

<!-- INSTRUCTION SCREEN -->
<div id="instruction">
 <div id="instructionBox">
  <h2>C√ÅCH CH∆†I</h2>
  <ul>
   <li><b>üëàüëâ Tap tr√°i/ph·∫£i</b> ƒë·ªÉ ƒë·ªïi l√†n ƒë∆∞·ªùng</li>
   <li><b>ü™ô Thu th·∫≠p Xu</b> - T√≠ch lu·ªπ ƒë·ªïi qu√† MoMo</li>
   <li><b>üß∫ M·ªói 5 Xu</b> nh·∫≠n <b>1 Gi·ªè C√°</b></li>
   <li><b>‚ö° C√†ng nhi·ªÅu Xu</b> ‚Üí T·ªëc ƒë·ªô c√†ng nhanh</li>
   <li><b>‚ùå Tr√°nh ch∆∞·ªõng ng·∫°i v·∫≠t</b> (ly, b·∫Øp ng√¥)</li>
   <li><b>üéÅ ƒê·∫°t 3 Gi·ªè C√°</b> ƒë·ªÉ nh·∫≠n Voucher MoMo</li>
  </ul>
  <button class="btn-momo" onclick="startGame()">üéÆ B·∫ÆT ƒê·∫¶U CH∆†I</button>
 </div>
</div>

<!-- CHARACTERS - Lazy loaded -->
<img id="but" data-src="assets/but.png" alt="√îng B·ª•t">
<img id="basketDrop" data-src="assets/basket.png" alt="Gi·ªè C√°">

<!-- HUD -->
<div id="hud">
 <div class="hud-item">
  <span class="hud-icon">üí∞</span>
  <span>Xu: <span id="coinEl" class="hud-value">0</span></span>
 </div>
 <div class="hud-item">
  <span class="hud-icon">üß∫</span>
  <span>Gi·ªè c√°: <span id="basketEl" class="hud-value">0</span></span>
 </div>
</div>

<!-- THANH PROGRESS -->
<div id="progressBox"><div id="progress"></div></div>

<!-- GAME OVER -->
<div id="over">
 <div id="over-content">
  <h2 style="color:#FFD700;font-size:36px;text-shadow:0 0 20px rgba(255,215,0,0.8);margin-bottom:30px;">‚ú®üßô‚Äç‚ôÇÔ∏è K·∫æT TH√öC</h2>
  
  <div id="summary">
   <div class="summary-item">
    <span>üí∞ XU THU ƒê∆Ø·ª¢C:</span>
    <span id="finalCoins" class="summary-value">0</span>
   </div>
   <div class="summary-item">
    <span>üß∫ GI·ªé C√Å:</span>
    <span id="finalBaskets" class="summary-value">0</span>
   </div>
   <div class="summary-item">
    <span>‚ö° T·ªêC ƒê·ªò CAO NH·∫§T:</span>
    <span id="finalSpeed" class="summary-value">0</span>
   </div>
  </div>

  <!-- VOUCHER POPUP -->
  <div id="voucherPopup">
   <h3>üéâ CH√öC M·ª™NG!</h3>
   <p>B·∫°n ƒë√£ ƒë·∫°t ƒë·ªß <b>3 Gi·ªè C√°</b> üéØ</p>
   
   <div class="voucher-image-container">
     <img id="voucherImage" class="voucher-image" data-src="" alt="Voucher MoMo">
   </div>
   
   <div class="voucher-brand" id="voucherBrand"></div>
   <div class="voucher-value" id="voucherValue"></div>
   <div class="voucher-code" id="voucherCode">MOMO-TET-2026</div>
   
   <div class="voucher-desc" id="voucherDesc">
     S·ª≠ d·ª•ng m√£ trong v√≠ MoMo ƒë·ªÉ nh·∫≠n ∆∞u ƒë√£i ƒë·∫∑c bi·ªát! üßß
   </div>
   
   <small id="voucherExpiry">H·∫°n s·ª≠ d·ª•ng: 31/12/2026</small>
  </div>

  <div id="nameBox">
   <label>üè∑ NH·∫¨P T√äN C·ª¶A B·∫†N</label>
   <input id="playerName" placeholder="T√™n ng∆∞·ªùi ch∆°i">
   <button class="btn-momo" onclick="saveScore()">üíæ L∆ØU K·∫æT QU·∫¢</button>
  </div>

  <div id="leaderboard">
   <h3>üèÜ B·∫¢NG X·∫æP H·∫†NG</h3>
   <div id="rankList"></div>
  </div>

  <!-- N√öT CH∆†I L·∫†I -->
  <button class="btn-momo" id="playAgainBtn" onclick="location.reload()">üîÑ CH∆†I L·∫†I</button>
 </div>
</div>

<canvas id="game" width="360" height="640"></canvas>
</div>

<script>
/* ===== OPTIMIZED FOR FAST LOADING ===== */

// 1. MINIMAL INITIALIZATION
function setVH() {
  document.documentElement.style.setProperty('--vh', window.innerHeight * 0.01 + 'px');
}

// 2. LAZY LOAD IMAGES
const lazyImages = {};
function lazyLoadImage(id, src) {
  if (lazyImages[id]) return lazyImages[id];
  
  const img = new Image();
  img.src = src;
  lazyImages[id] = img;
  return img;
}

// 3. DEFER NON-CRITICAL RESOURCES
const deferredAssets = [
  'assets/but.png',
  'assets/basket.png',
  'assets/obs-rock.png',
  'assets/obs-log.png',
  'assets/obs-pot.png',
  'assets/background.mp3',
  'assets/coin.mp3',
  'assets/basket.mp3',
  'assets/hit.mp3',
  'assets/click.mp3',
  'assets/speedup.mp3',
  'assets/but.mp3',
  'assets/magic.mp3',
  'assets/win.mp3'
];

// 4. SIMPLIFIED VOUCHER LIST - REDUCED SIZE
const voucherList = [
  {id:1,name:"Highlands",code:"HLD-MOMO-50K",brand:"HIGHLANDS",value:"GI·∫¢M 30K",desc:"Gi·∫£m 30K cho h√≥a ƒë∆°n t·ª´ 100K",color:"#8B4513",expiry:"31/03/2026"},
  {id:2,name:"Grab",code:"GRAB-MOMO-50K",brand:"GRAB",value:"GI·∫¢M 40K",desc:"Gi·∫£m 50K cho chuy·∫øn xe Grab",color:"#00B14F",expiry:"31/03/2026"},
  {id:3,name:"GS25",code:"GS25-MOMO-25k",brand:"GS25",value:"GI·∫¢M 25k",desc:"Gi·∫£m 25k cho h√≥a ƒë∆°n t·ª´ 80K",color:"#FF6B00",expiry:"31/03/2026"}
];

// 5. CREATE FALLBACK IMAGES INLINE
function createFallbackSVG(color, text) {
  return `data:image/svg+xml;base64,${btoa(`
    <svg width="300" height="220" viewBox="0 0 300 220" xmlns="http://www.w3.org/2000/svg">
      <rect width="300" height="220" rx="15" fill="white"/>
      <rect x="10" y="10" width="280" height="200" rx="10" fill="${color}20" stroke="${color}" stroke-width="2"/>
      <text x="150" y="80" font-family="Arial" font-size="24" font-weight="bold" fill="${color}" text-anchor="middle">${text}</text>
    </svg>
  `)}`;
}

// 6. OPTIMIZED GAME INITIALIZATION
let initialized = false;
function initGame() {
  if (initialized) return;
  initialized = true;
  
  // Load critical game images
  gameImages.road = new Image();
  gameImages.road.src = 'assets/road.png';
  
  gameImages.player = new Image();
  gameImages.player.src = 'assets/cotam-run.png';
  gameImages.player.onload = () => {
    SW = gameImages.player.width / RUN_FRAMES;
    SH = gameImages.player.height;
  };
  
  gameImages.coin = new Image();
  gameImages.coin.src = 'assets/coin.png';
  
  // Load obstacles lazily when needed
  gameImages.obs1 = new Image();
  gameImages.obs1.src = 'assets/obs-rock.png';
  gameImages.obs2 = new Image();
  gameImages.obs2.src = 'assets/obs-log.png';
  gameImages.obs3 = new Image();
  gameImages.obs3.src = 'assets/obs-pot.png';
}

// 7. PRELOAD AFTER INITIAL RENDER
window.addEventListener('load', function() {
  setVH();
  initializeGameSize();
  
  // Load game images after a short delay
  setTimeout(initGame, 100);
  
  // Load deferred assets in background
  setTimeout(() => {
    deferredAssets.forEach(src => {
      const img = new Image();
      img.src = src;
    });
  }, 500);
});

window.addEventListener('resize', setVH);
window.addEventListener('orientationchange', () => setTimeout(setVH, 150));

// 8. MINIMAL GAME STATE
let run = false, coin = 0, basket = 0;
let baseSpeed = 3.5, speed = baseSpeed, speedStep = 0.7, maxSpeed = 9;
let roadY = 0;
const lanes = [60, 180, 300];
let player = { lane: 1, y: 520 };
let coins = [], obstacles = [];
let coinTimer = 0, obstacleTimer = 0;
let frameCount = 0;
let butTimeout = null;
let lastMilestone = 0;
const RUN_FRAMES = 4;
let runFrame = 0, runTick = 0;
let SW = 0, SH = 0;
const PLAYER_WIDTH = 55;
const PLAYER_HEIGHT = 82;
const PLAYER_OFFSET_X = PLAYER_WIDTH / 2;
const PLAYER_OFFSET_Y = 60;

// 9. GAME IMAGES OBJECT
const gameImages = {};

// 10. OPTIMIZED AUDIO - LOAD ON DEMAND
const audioCache = {};
function getAudio(src) {
  if (!audioCache[src]) {
    audioCache[src] = new Audio(src);
    audioCache[src].volume = 0.5;
  }
  return audioCache[src];
}

// 11. OPTIMIZED GAME FUNCTIONS
function showInstruction() {
  document.getElementById('start').style.display = 'none';
  document.getElementById('instruction').style.display = 'flex';
  initGame(); // Ensure game is initialized
}

function startGame() {
  document.getElementById('instruction').style.display = 'none';
  run = true;
  lastMilestone = 0;
  loop();
}

/* ===== OPTIMIZED GAME LOOP ===== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

function loop() {
  if (!run) return;
  frameCount++;
  
  // Clear canvas efficiently
  ctx.clearRect(0, 0, 360, 640);
  
  // Draw road
  roadY += speed;
  if (roadY >= 640) roadY = 0;
  
  if (gameImages.road) {
    ctx.drawImage(gameImages.road, 0, roadY - 640, 360, 640);
    ctx.drawImage(gameImages.road, 0, roadY, 360, 640);
  }
  
  // Draw player
  runTick++;
  if (runTick % 6 === 0) runFrame = (runFrame + 1) % RUN_FRAMES;
  
  if (gameImages.player && SW) {
    ctx.drawImage(
      gameImages.player,
      runFrame * SW, 0, SW, SH,
      lanes[player.lane] - PLAYER_OFFSET_X,
      player.y - PLAYER_OFFSET_Y,
      PLAYER_WIDTH,
      PLAYER_HEIGHT
    );
  }
  
  // Draw coins
  for (let i = coins.length - 1; i >= 0; i--) {
    const c = coins[i];
    c.y += speed;
    
    if (gameImages.coin) {
      ctx.save();
      ctx.translate(lanes[c.lane], c.y);
      ctx.rotate(c.angle);
      ctx.drawImage(gameImages.coin, -15, -15, 30, 30);
      ctx.restore();
    }
    
    // Check collision
    if (c.lane === player.lane && Math.abs(c.y - player.y) < 45) {
      coins.splice(i, 1);
      coin++;
      document.getElementById('coinEl').innerText = coin;
      
      // 5 xu = 1 gi·ªè c√°
      const milestone = Math.floor(coin / 5);
      if (milestone > basket) {
        basket = milestone;
        document.getElementById('basketEl').innerText = basket;
        document.getElementById('progress').style.width = ((coin % 5) / 5 * 100) + "%";
      }
      
      speed = Math.min(baseSpeed + milestone * speedStep, maxSpeed);
    }
  }
  
  // Spawn coins
  coinTimer++;
  if (coinTimer > 25) {
    coins.push({
      lane: Math.floor(Math.random() * 3),
      y: -40,
      angle: Math.random() * Math.PI * 2
    });
    coinTimer = 0;
  }
  
  requestAnimationFrame(loop);
}

// 12. SIMPLIFIED TOUCH CONTROLS
canvas.addEventListener("touchstart", function(e) {
  e.preventDefault();
  const touch = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  player.lane = touch.clientX - rect.left < rect.width / 2 ? 
    Math.max(0, player.lane - 1) : Math.min(2, player.lane + 1);
});

// 13. SIMPLE GAME OVER
function endGame() {
  run = false;
  setTimeout(() => {
    document.getElementById('over').style.display = 'flex';
    document.getElementById('finalCoins').textContent = coin;
    document.getElementById('finalBaskets').textContent = basket;
    document.getElementById('finalSpeed').textContent = speed.toFixed(1);
    
    if (basket >= 3) {
      const voucher = voucherList[Math.floor(Math.random() * voucherList.length)];
      document.getElementById('voucherPopup').style.display = 'block';
      document.getElementById('voucherCode').textContent = voucher.code;
      document.getElementById('voucherBrand').textContent = voucher.brand;
      document.getElementById('voucherValue').textContent = voucher.value;
      document.getElementById('voucherDesc').textContent = voucher.desc;
      document.getElementById('voucherExpiry').textContent = `H·∫°n s·ª≠ d·ª•ng: ${voucher.expiry}`;
    }
  }, 500);
}

// 14. MINIMAL SCORE SAVING
function saveScore() {
  const name = document.getElementById('playerName').value.trim() || "Ng∆∞·ªùi Ch∆°i";
  let lb = JSON.parse(localStorage.getItem("leaderboard") || "[]");
  lb.push({ name, coin, basket, speed: speed.toFixed(1) });
  lb.sort((a, b) => b.coin - a.coin);
  lb = lb.slice(0, 8);
  localStorage.setItem("leaderboard", JSON.stringify(lb));
  
  document.getElementById('nameBox').style.display = 'none';
  document.getElementById('leaderboard').style.display = 'block';
  
  const rankList = document.getElementById('rankList');
  rankList.innerHTML = '';
  lb.forEach((r, i) => {
    const rankDiv = document.createElement('div');
    rankDiv.className = `rank ${r.name === name ? 'you' : ''}`;
    rankDiv.innerHTML = `<span>${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : ''} ${r.name}</span><span>üí∞ ${r.coin}</span><span>üß∫ ${r.basket}</span>`;
    rankList.appendChild(rankDiv);
  });
}

// 15. SOUND SYSTEM
let soundEnabled = true;
function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('soundIcon').textContent = soundEnabled ? 'üîä' : 'üîá';
}
</script>
</body>
</html>
