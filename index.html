<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Nh·∫∑t ƒê·ªìng Nh·ªè - V√≠ MoMo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#A50064">

<!-- Preload c√°c t√†i nguy√™n quan tr·ªçng -->
<link rel="preload" as="image" href="assets/start.png">
<link rel="preload" as="image" href="assets/cotam-run.png">
<link rel="preload" as="image" href="assets/road.png">
<link rel="preload" as="image" href="assets/coin.png">

<style>
/* CSS Variables - T·ªëi ∆∞u CSS */
:root {
  --vh: 1vh;
  --momo-pink: #A50064;
  --momo-gold: #FFD700;
  --game-width: 360px;
  --game-height: 640px;
}

/* Reset minimal */
*{box-sizing:border-box;margin:0;padding:0}

/* Body optimized */
body{
 margin:0;
 padding:0;
 background:#000;
 font-family:'Segoe UI', system-ui, -apple-system, sans-serif;
 display:flex;
 align-items:center;
 justify-content:center;
 min-height:100vh;
 min-height:calc(var(--vh, 1vh) * 100);
 background: linear-gradient(135deg, #1a0033 0%, #330066 50%, #4d0099 100%);
 position:fixed;
 top:0;
 left:0;
 right:0;
 bottom:0;
 width:100vw;
 height:100vh;
 height:calc(var(--vh, 1vh) * 100);
 -webkit-tap-highlight-color:transparent;
 touch-action:none;
 -webkit-user-select:none;
 user-select:none;
}

/* GAME WRAPPER */
#gameWrapper{
 position:relative;
 width:100%;
 height:100%;
 max-width:var(--game-width);
 max-height:var(--game-height);
 margin:auto;
 transform-origin:center center;
 filter:drop-shadow(0 10px 30px rgba(0,0,0,0.5));
 touch-action:manipulation;
 overflow:hidden;
 display:flex;
 align-items:center;
 justify-content:center;
}

/* INTRO SCREEN */
#start{
 position:absolute;
 top:0;
 left:0;
 width:100%;
 height:100%;
 z-index:50;
 cursor:pointer;
 background:#000;
 display:flex;
 align-items:center;
 justify-content:center;
 overflow:hidden;
}
#start img{
 width:100%;
 height:100%;
 object-fit:cover;
 pointer-events:none;
}

/* INSTRUCTION SCREEN - Simplified */
#instruction{
 position:absolute;
 top:0;
 left:0;
 width:100%;
 height:100%;
 color:#fff;
 display:none;
 flex-direction:column;
 align-items:center;
 justify-content:center;
 padding:20px;
 z-index:40;
 text-align:center;
 background:var(--momo-pink);
}
#instructionBox{
 background:rgba(255,255,255,0.15);
 backdrop-filter:blur(10px);
 border:2px solid rgba(255,255,255,0.25);
 padding:20px;
 border-radius:20px;
 max-width:320px;
 width:90%;
}
#instructionBox h2{
 margin-top:0;
 color:#fff;
 font-size:24px;
 margin-bottom:15px;
}
#instructionBox ul{
 text-align:left;
 padding-left:20px;
 line-height:1.5;
 color:#fff;
 font-size:14px;
 margin-bottom:20px;
}
#instructionBox li{
 margin-bottom:12px;
}
#instructionBox b{
 color:var(--momo-gold);
}

/* HUD Simplified */
#hud{
 position:absolute;
 top:15px;
 left:15px;
 color:#fff;
 font-weight:bold;
 z-index:10;
 background:rgba(165,0,100,0.85);
 padding:10px 15px;
 border-radius:15px;
 border:2px solid rgba(255,215,0,0.3);
}
.hud-item{
 display:flex;
 align-items:center;
 gap:8px;
 margin-bottom:5px;
}
.hud-value{
 font-size:20px;
 color:var(--momo-gold);
}

/* SOUND BUTTON */
#soundBtn{
 position:absolute;
 top:15px;
 right:15px;
 width:40px;
 height:40px;
 background:rgba(165,0,100,0.85);
 border-radius:50%;
 border:2px solid rgba(255,215,0,0.3);
 display:flex;
 align-items:center;
 justify-content:center;
 cursor:pointer;
 z-index:11;
}

/* PROGRESS BAR */
#progressBox{
 position:absolute;
 top:120px;
 left:15px;
 width:180px;
 height:12px;
 background:rgba(255,255,255,0.1);
 border-radius:8px;
 overflow:hidden;
}
#progress{
 height:100%;
 width:0%;
 background:linear-gradient(90deg,var(--momo-gold),#FFB300);
 transition:width 0.3s ease;
}

/* CANVAS */
canvas{
 display:block;
 width:100%;
 height:100%;
 border-radius:15px;
 overflow:hidden;
 box-shadow:0 10px 20px rgba(0,0,0,0.3);
 -webkit-touch-callout:none;
}

/* BUTTONS */
.btn-momo{
 margin-top:15px;
 padding:12px 24px;
 border:none;
 border-radius:20px;
 font-size:16px;
 font-weight:bold;
 background:linear-gradient(135deg,var(--momo-gold),#FFB300);
 color:var(--momo-pink);
 cursor:pointer;
 transition:transform 0.2s ease;
 font-family:inherit;
}

/* CHARACTERS */
#but, #basketDrop{
 position:absolute;
 z-index:15;
 pointer-events:none;
 display:none;
}
#but{
 top:100px;
 left:50%;
 transform:translateX(-50%);
 width:120px;
}
#basketDrop{
 top:200px;
 left:50%;
 transform:translateX(-50%);
 width:60px;
}

/* GAME OVER */
#over{
 position:absolute;
 top:0;
 left:0;
 width:100%;
 height:100%;
 display:none;
 align-items:center;
 justify-content:center;
 flex-direction:column;
 color:#fff;
 z-index:50;
 padding:20px;
 text-align:center;
 background:var(--momo-pink);
}
#over-content{
 display:flex;
 flex-direction:column;
 align-items:center;
 width:100%;
 max-width:300px;
}
#summary{
 background:rgba(255,255,255,0.15);
 backdrop-filter:blur(10px);
 padding:15px;
 border-radius:15px;
 width:100%;
 margin-bottom:15px;
}
.summary-item{
 display:flex;
 justify-content:space-between;
 align-items:center;
 margin-bottom:10px;
}
.summary-value{
 font-size:20px;
 font-weight:bold;
 color:var(--momo-gold);
}

/* VOUCHER POPUP Simplified */
#voucherPopup{
 display:none;
 background:linear-gradient(135deg,var(--momo-gold),#FFB300);
 color:var(--momo-pink);
 padding:15px;
 border-radius:15px;
 width:100%;
 margin-bottom:15px;
 text-align:center;
 border:2px solid rgba(255,255,255,0.7);
}
.voucher-image-container{
 width:100%;
 height:150px;
 margin:10px 0;
 border-radius:10px;
 overflow:hidden;
 background:rgba(255,255,255,0.9);
 display:flex;
 align-items:center;
 justify-content:center;
}
.voucher-image{
 width:100%;
 height:100%;
 object-fit:cover;
}
.voucher-code{
 font-size:20px;
 font-weight:bold;
 background:rgba(255,255,255,0.95);
 padding:10px;
 border-radius:10px;
 margin:10px 0;
 color:var(--momo-pink);
 border:2px dashed var(--momo-pink);
 font-family:'Courier New',monospace;
}

/* Responsive fixes */
@media (max-height: 500px) and (orientation: landscape) {
  #gameWrapper {
    max-height: 90vh;
    transform: scale(0.8);
  }
}

@supports (-webkit-touch-callout: none) {
  body {
    height: -webkit-fill-available;
  }
}
</style>
</head>

<body>

<div id="gameWrapper">
<!-- START SCREEN -->
<div id="start" onclick="showInstruction()">
 <img src="assets/start.png" alt="MoMo Game" id="startImage">
</div>

<!-- SOUND BUTTON -->
<div id="soundBtn" onclick="toggleSound()">
 <span id="soundIcon">üîä</span>
</div>

<!-- INSTRUCTION SCREEN -->
<div id="instruction">
 <div id="instructionBox">
  <h2>C√ÅCH CH∆†I</h2>
  <ul>
   <li><b>üëàüëâ Tap tr√°i/ph·∫£i</b> ƒë·ªÉ ƒë·ªïi l√†n ƒë∆∞·ªùng</li>
   <li><b>ü™ô Thu th·∫≠p Xu</b> - T√≠ch lu·ªπ ƒë·ªïi qu√† MoMo</li>
   <li><b>üß∫ M·ªói 5 Xu</b> nh·∫≠n <b>1 Gi·ªè C√°</b></li>
   <li><b>‚ö° C√†ng nhi·ªÅu Xu</b> ‚Üí T·ªëc ƒë·ªô c√†ng nhanh</li>
   <li><b>‚ùå Tr√°nh ch∆∞·ªõng ng·∫°i v·∫≠t</b></li>
   <li><b>üéÅ ƒê·∫°t 3 Gi·ªè C√°</b> ƒë·ªÉ nh·∫≠n Voucher MoMo</li>
  </ul>
  <button class="btn-momo" onclick="startGame()">üéÆ B·∫ÆT ƒê·∫¶U CH∆†I</button>
 </div>
</div>

<!-- CHARACTERS -->
<img id="but" src="assets/but.png" alt="√îng B·ª•t">
<img id="basketDrop" src="assets/basket.png" alt="Gi·ªè C√°">

<!-- HUD -->
<div id="hud">
 <div class="hud-item">
  <span>üí∞ Xu:</span>
  <span id="coinEl" class="hud-value">0</span>
 </div>
 <div class="hud-item">
  <span>üß∫ Gi·ªè c√°:</span>
  <span id="basketEl" class="hud-value">0</span>
 </div>
</div>

<!-- PROGRESS BAR -->
<div id="progressBox"><div id="progress"></div></div>

<!-- GAME OVER SCREEN -->
<div id="over">
 <div id="over-content">
  <h2 style="color:var(--momo-gold);margin-bottom:20px;">‚ú® K·∫æT TH√öC</h2>
  
  <div id="summary">
   <div class="summary-item">
    <span>üí∞ XU:</span>
    <span id="finalCoins" class="summary-value">0</span>
   </div>
   <div class="summary-item">
    <span>üß∫ GI·ªé C√Å:</span>
    <span id="finalBaskets" class="summary-value">0</span>
   </div>
  </div>

  <!-- VOUCHER POPUP -->
  <div id="voucherPopup">
   <h3>üéâ CH√öC M·ª™NG!</h3>
   <p>B·∫°n ƒë√£ ƒë·∫°t ƒë·ªß <b>3 Gi·ªè C√°</b> üéØ</p>
   
   <div class="voucher-image-container">
     <img id="voucherImage" class="voucher-image" src="" alt="Voucher MoMo">
   </div>
   
   <div class="voucher-code" id="voucherCode">MOMO-TET-2026</div>
  </div>

  <!-- NAME INPUT -->
  <div id="nameBox" style="width:100%;margin:15px 0;">
   <input id="playerName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--momo-gold);margin-bottom:10px;">
   <button class="btn-momo" onclick="saveScore()" style="width:100%">üíæ L∆ØU K·∫æT QU·∫¢</button>
  </div>

  <!-- LEADERBOARD -->
  <div id="leaderboard" style="display:none;width:100%;background:white;color:var(--momo-pink);padding:15px;border-radius:15px;margin:10px 0;">
   <h3 style="margin-top:0;">üèÜ B·∫¢NG X·∫æP H·∫†NG</h3>
   <div id="rankList"></div>
  </div>

  <!-- PLAY AGAIN BUTTON -->
  <button class="btn-momo" id="playAgainBtn" onclick="location.reload()" style="width:100%;margin-top:10px;">üîÑ CH∆†I L·∫†I</button>
 </div>
</div>

<canvas id="game" width="360" height="640"></canvas>
</div>

<script>
/* ===== T·ªêI ∆ØU H√ìA LOADING ===== */
// Preload c√°c h√¨nh ·∫£nh quan tr·ªçng
function preloadCriticalImages() {
    const criticalImages = [
        'assets/road.png',
        'assets/cotam-run.png',
        'assets/coin.png',
        'assets/but.png',
        'assets/basket.png'
    ];
    
    criticalImages.forEach(src => {
        const img = new Image();
        img.src = src;
    });
}

// Kh·ªüi t·∫°o game ngay khi DOM s·∫µn s√†ng
document.addEventListener('DOMContentLoaded', function() {
    preloadCriticalImages();
    setupGame();
});

/* ===== THI·∫æT L·∫¨P GAME ===== */
function setupGame() {
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    
    // T·∫£i h√¨nh ·∫£nh v·ªõi fallback
    const images = {
        road: createImage('assets/road.png', '#330066'),
        player: createImage('assets/cotam-run.png', '#A50064'),
        coin: createImage('assets/coin.png', '#FFD700'),
        but: document.getElementById('but'),
        basket: document.getElementById('basketDrop')
    };
    
    // T·∫°o h√¨nh ·∫£nh fallback
    function createImage(src, fallbackColor) {
        const img = new Image();
        img.src = src;
        img.onerror = function() {
            // T·∫°o h√¨nh ·∫£nh fallback ƒë∆°n gi·∫£n
            const fallbackCanvas = document.createElement('canvas');
            const fallbackCtx = fallbackCanvas.getContext('2d');
            fallbackCanvas.width = 50;
            fallbackCanvas.height = 50;
            fallbackCtx.fillStyle = fallbackColor;
            fallbackCtx.fillRect(0, 0, 50, 50);
            img.src = fallbackCanvas.toDataURL();
        };
        return img;
    }
    
    /* ===== GAME STATE ===== */
    let run = false, coin = 0, basket = 0;
    let baseSpeed = 3.5, speed = baseSpeed, speedStep = 0.7, maxSpeed = 9;
    let roadY = 0;
    const lanes = [60, 180, 300];
    let player = { lane: 1, y: 520 };
    let coins = [], obstacles = [];
    let coinTimer = 0, obstacleTimer = 0;
    let frameCount = 0;
    
    /* ===== VOUCHER SYSTEM ===== */
    const voucherList = [
        {
            id: 1,
            name: "Highlands Coffee",
            image: "assets/voucher/highlands.png",
            code: "HLD-MOMO-50K",
            brand: "HIGHLANDS COFFEE",
            value: "GI·∫¢M 30K",
            color: "#8B4513"
        },
        {
            id: 2,
            name: "Grab",
            image: "assets/voucher/grab.png",
            code: "GRAB-MOMO-50K",
            brand: "GRAB",
            value: "GI·∫¢M 40K",
            color: "#00B14F"
        },
        {
            id: 3,
            name: "Starbucks",
            image: "assets/voucher/starbucks.png",
            code: "SBUX-MOMO-50K",
            brand: "STARBUCKS",
            value: "GI·∫¢M 50K",
            color: "#00704A"
        }
    ];
    
    // Ch·ªçn voucher ng·∫´u nhi√™n
    function getRandomVoucher() {
        const randomIndex = Math.floor(Math.random() * voucherList.length);
        return voucherList[randomIndex];
    }
    
    /* ===== SOUND SYSTEM ===== */
    let soundEnabled = true;
    const clickSound = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
    
    function toggleSound() {
        soundEnabled = !soundEnabled;
        document.getElementById('soundIcon').textContent = soundEnabled ? 'üîä' : 'üîá';
    }
    
    /* ===== GAME FUNCTIONS ===== */
    function showInstruction(){
        document.getElementById('start').style.display = 'none';
        document.getElementById('instruction').style.display = 'flex';
    }
    
    function startGame(){
        document.getElementById('instruction').style.display = 'none';
        run = true;
        lastMilestone = 0;
        gameLoop();
    }
    
    // Spawn coin
    function spawnCoin() {
        const lane = Math.floor(Math.random() * 3);
        coins.push({
            lane,
            y: -40,
            size: 20 + Math.random() * 10
        });
    }
    
    // Spawn obstacles
    function spawnObstacle() {
        const lane = Math.floor(Math.random() * 3);
        const size = 30 + Math.random() * 20;
        obstacles.push({
            lane,
            y: -50,
            size: size,
            type: Math.floor(Math.random() * 3),
            speed: 3 + Math.random() * 2
        });
    }
    
    // V·∫Ω h√¨nh ·∫£nh v·ªõi fallback
    function drawImageWithFallback(ctx, img, x, y, width, height, fallbackColor) {
        if (img.complete && img.naturalWidth !== 0) {
            ctx.drawImage(img, x, y, width, height);
        } else {
            ctx.fillStyle = fallbackColor;
            ctx.fillRect(x, y, width, height);
        }
    }
    
    // Main game loop
    function gameLoop(){
        if(!run) return;
        frameCount++;
        
        // Clear canvas
        ctx.clearRect(0, 0, 360, 640);
        
        // Draw road
        roadY += speed;
        if(roadY >= 640) roadY = 0;
        
        drawImageWithFallback(ctx, images.road, 0, roadY - 640, 360, 640, '#330066');
        drawImageWithFallback(ctx, images.road, 0, roadY, 360, 640, '#330066');
        
        // Draw player
        const playerX = lanes[player.lane] - 25;
        drawImageWithFallback(ctx, images.player, playerX, player.y - 60, 50, 60, '#A50064');
        
        // Draw coins
        for(let i = coins.length - 1; i >= 0; i--){
            const c = coins[i];
            c.y += speed;
            
            drawImageWithFallback(ctx, images.coin, lanes[c.lane] - c.size/2, c.y - c.size/2, c.size, c.size, '#FFD700');
            
            // Check collision
            if(c.lane === player.lane && Math.abs(c.y - player.y) < 40){
                coins.splice(i, 1);
                coin++;
                document.getElementById('coinEl').innerText = coin;
                
                // M·ªói 5 xu = 1 gi·ªè c√°
                const milestone = Math.floor(coin / 5);
                if(milestone > basket){
                    basket = milestone;
                    document.getElementById('basketEl').innerText = basket;
                    
                    // Hi·ªÉn th·ªã √¥ng B·ª•t
                    showCharacter('but');
                    
                    // Hi·ªÉn th·ªã gi·ªè c√°
                    showCharacter('basket');
                }
                
                // C·∫≠p nh·∫≠t progress bar
                document.getElementById('progress').style.width = ((coin % 5) / 5 * 100) + "%";
                
                // TƒÉng t·ªëc ƒë·ªô
                speed = Math.min(baseSpeed + milestone * speedStep, maxSpeed);
            }
        }
        
        // Draw obstacles
        for(let i = obstacles.length - 1; i >= 0; i--){
            const o = obstacles[i];
            o.y += o.speed;
            
            ctx.fillStyle = o.type === 0 ? '#8B4513' : o.type === 1 ? '#654321' : '#808080';
            ctx.fillRect(lanes[o.lane] - o.size/2, o.y - o.size/2, o.size, o.size);
            
            // Check collision
            if(o.lane === player.lane && Math.abs(o.y - player.y) < 40){
                endGame();
                return;
            }
        }
        
        // Spawn objects
        coinTimer++;
        obstacleTimer++;
        
        if(coinTimer > 25){
            spawnCoin();
            coinTimer = 0;
        }
        if(obstacleTimer > 75){
            spawnObstacle();
            obstacleTimer = 0;
        }
        
        requestAnimationFrame(gameLoop);
    }
    
    // Hi·ªÉn th·ªã nh√¢n v·∫≠t
    function showCharacter(type) {
        const element = document.getElementById(type);
        element.style.display = 'block';
        
        if(type === 'basket') {
            element.style.transform = 'translateX(-50%) scale(1)';
            setTimeout(() => {
                element.style.display = 'none';
            }, 1000);
        } else if(type === 'but') {
            setTimeout(() => {
                element.style.display = 'none';
            }, 2000);
        }
    }
    
    // K·∫øt th√∫c game
    function endGame(){
        run = false;
        
        document.getElementById('finalCoins').textContent = coin;
        document.getElementById('finalBaskets').textContent = basket;
        
        setTimeout(() => {
            document.getElementById('over').style.display = 'flex';
            
            if(basket >= 3){
                showVoucher();
            }
        }, 500);
    }
    
    // Hi·ªÉn th·ªã voucher
    function showVoucher() {
        const voucher = getRandomVoucher();
        const voucherPopup = document.getElementById('voucherPopup');
        const voucherImage = document.getElementById('voucherImage');
        const voucherCode = document.getElementById('voucherCode');
        
        voucherImage.src = voucher.image;
        voucherCode.textContent = voucher.code;
        voucherCode.style.background = `linear-gradient(135deg, ${voucher.color}20, ${voucher.color}40)`;
        voucherCode.style.borderColor = voucher.color;
        voucherCode.style.color = voucher.color;
        
        voucherPopup.style.display = 'block';
    }
    
    // L∆∞u ƒëi·ªÉm
    function saveScore(){
        const name = document.getElementById('playerName').value.trim() || "Ng∆∞·ªùi Ch∆°i";
        let lb = JSON.parse(localStorage.getItem("leaderboard") || "[]");
        
        lb.push({
            name, 
            coin,
            basket,
            date: new Date().toLocaleDateString('vi-VN')
        });
        
        lb.sort((a, b) => b.coin - a.coin);
        lb = lb.slice(0, 5);
        
        localStorage.setItem("leaderboard", JSON.stringify(lb));
        
        // Hi·ªÉn th·ªã b·∫£ng x·∫øp h·∫°ng
        document.getElementById('nameBox').style.display = 'none';
        document.getElementById('leaderboard').style.display = 'block';
        
        const rankList = document.getElementById('rankList');
        rankList.innerHTML = '';
        
        lb.forEach((r, i) => {
            const rankDiv = document.createElement('div');
            rankDiv.style.display = 'flex';
            rankDiv.style.justifyContent = 'space-between';
            rankDiv.style.padding = '5px 0';
            rankDiv.style.borderBottom = i < lb.length - 1 ? '1px solid #ddd' : 'none';
            
            let medal = '';
            if(i === 0) medal = 'ü•á ';
            else if(i === 1) medal = 'ü•à ';
            else if(i === 2) medal = 'ü•â ';
            
            rankDiv.innerHTML = `
                <span>${medal}${r.name}</span>
                <span>üí∞ ${r.coin}</span>
            `;
            rankList.appendChild(rankDiv);
        });
    }
    
    /* ===== TOUCH CONTROLS ===== */
    canvas.addEventListener("touchstart", function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const touchX = touch.clientX - rect.left;
        
        player.lane = touchX < rect.width / 2 ? Math.max(0, player.lane - 1) : Math.min(2, player.lane + 1);
    });
    
    /* ===== KEYBOARD CONTROLS (for testing) ===== */
    document.addEventListener("keydown", function(e) {
        if(e.key === "ArrowLeft") {
            player.lane = Math.max(0, player.lane - 1);
        } else if(e.key === "ArrowRight") {
            player.lane = Math.min(2, player.lane + 1);
        } else if(e.key === "Enter" && !run && document.getElementById('instruction').style.display === 'flex') {
            startGame();
        }
    });
}

/* ===== FIX VIEWPORT FOR MOBILE ===== */
function setVH() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}

window.addEventListener('load', setVH);
window.addEventListener('resize', setVH);
window.addEventListener('orientationchange', setVH);
</script>
</body>
</html>
