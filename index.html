<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Nh·∫∑t ƒê·ªìng Nh·ªè - V√≠ MoMo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#A50064">

<style>
/* CSS Variables */
:root {
  --vh: 1vh;
}

/* Reset */
*{box-sizing:border-box;margin:0;padding:0}

/* Body - Fullscreen */
body{
 margin:0;
 padding:0;
 background:#000;
 overflow:hidden;
 font-family:'Segoe UI', system-ui, -apple-system, sans-serif;
 display:flex;
 align-items:center;
 justify-content:center;
 min-height:100vh;
 min-height:calc(var(--vh, 1vh) * 100);
 background: linear-gradient(135deg, #1a0033 0%, #330066 50%, #4d0099 100%);
 position:fixed;
 top:0;
 left:0;
 right:0;
 bottom:0;
 width:100vw;
 height:100vh;
 height:calc(var(--vh, 1vh) * 100);
 -webkit-tap-highlight-color:transparent;
 touch-action:none;
 -webkit-user-select:none;
 user-select:none;
}

/* GAME WRAPPER */
#gameWrapper{
 position:relative;
 width:100%;
 height:100%;
 max-width:360px;
 max-height:640px;
 margin:auto;
 transform-origin:center center;
 filter:drop-shadow(0 10px 30px rgba(0,0,0,0.5));
 touch-action:manipulation;
 overflow:hidden;
 display:flex;
 align-items:center;
 justify-content:center;
}

/* INTRO SCREEN - FIXED */
#start{
 position:absolute;
 top:0;
 left:0;
 width:100%;
 height:100%;
 z-index:50;
 cursor:pointer;
 background:#000;
 display:flex;
 align-items:center;
 justify-content:center;
 overflow:hidden;
}
#start img{
 width:100%;
 height:100%;
 object-fit:cover;
 pointer-events:none;
 display:block;
 margin:auto;
 max-width:100%;
 max-height:100%;
}

/* INSTRUCTION SCREEN */
#instruction{
 position:absolute;
 top:0;
 left:0;
 width:100%;
 height:100%;
 color:#fff;
 display:none;
 flex-direction:column;
 align-items:center;
 justify-content:center;
 padding:20px;
 z-index:40;
 text-align:center;
 background:linear-gradient(-45deg,#A50064,#D6006E,#FF0077,#FF3399,#A50064,#D6006E,#FF0077,#FF3399);
 background-size:400% 400%;
 animation:gradientFlow 8s ease infinite;
}
@keyframes gradientFlow{
 0%{background-position:0% 50%}
 50%{background-position:100% 50%}
 100%{background-position:0% 50%}
}

#instructionBox{
 background:rgba(255,255,255,0.15);
 backdrop-filter:blur(20px);
 -webkit-backdrop-filter:blur(20px);
 border:2px solid rgba(255,255,255,0.25);
 padding:30px;
 border-radius:25px;
 max-width:320px;
 width:90%;
 box-shadow:0 20px 40px rgba(0,0,0,0.3),0 0 0 1px rgba(255,255,255,0.1) inset;
}
#instructionBox h2{
 margin-top:0;
 color:#fff;
 font-size:28px;
 text-shadow:0 2px 10px rgba(0,0,0,0.3);
 margin-bottom:25px;
 padding-bottom:15px;
 border-bottom:2px solid rgba(255,255,255,0.3);
 position:relative;
}
#instructionBox h2::after{
 content:'';
 position:absolute;
 bottom:-2px;
 left:50%;
 transform:translateX(-50%);
 width:100px;
 height:3px;
 background:linear-gradient(90deg,transparent,#FFD700,transparent);
}
#instructionBox ul{
 text-align:left;
 padding-left:25px;
 line-height:1.7;
 color:#fff;
 font-size:16px;
 margin-bottom:25px;
 list-style:none;
}
#instructionBox li{
 margin-bottom:16px;
 padding-left:35px;
 position:relative;
}
#instructionBox li::before{
 content:'';
 position:absolute;
 left:0;
 top:50%;
 transform:translateY(-50%);
 width:24px;
 height:24px;
 background:rgba(255,215,0,0.2);
 border-radius:50%;
 border:2px solid #FFD700;
}
#instructionBox li::after{
 content:'‚úì';
 position:absolute;
 left:0;
 top:50%;
 transform:translateY(-50%);
 width:24px;
 height:24px;
 color:#FFD700;
 font-weight:bold;
 text-align:center;
 line-height:24px;
}
#instructionBox b{
 color:#FFD700;
 font-weight:800;
 text-shadow:0 0 10px rgba(255,215,0,0.5);
}

/* HUD */
#hud{
 position:absolute;
 top:20px;
 left:20px;
 color:#fff;
 font-weight:bold;
 z-index:10;
 background:rgba(165,0,100,0.85);
 padding:15px 20px;
 border-radius:20px;
 border:2px solid rgba(255,215,0,0.3);
 box-shadow:0 10px 20px rgba(0,0,0,0.3);
 backdrop-filter:blur(10px);
 -webkit-backdrop-filter:blur(10px);
}
.hud-item{
 display:flex;
 align-items:center;
 gap:10px;
 margin-bottom:10px;
}
.hud-item:last-child{
 margin-bottom:0;
}
.hud-icon{
 font-size:24px;
 filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}
.hud-value{
 font-size:24px;
 color:#FFD700;
 text-shadow:0 0 10px rgba(255,215,0,0.5);
}

/* PROGRESS */
#progressBox{
 position:absolute;
 top:145px;
 left:20px;
 width:200px;
 height:16px;
 background:rgba(255,255,255,0.1);
 border-radius:10px;
 overflow:hidden;
 border:2px solid rgba(255,255,255,0.2);
 box-shadow:0 5px 15px rgba(0,0,0,0.2);
}
#progress{
 height:100%;
 width:0%;
 background:linear-gradient(90deg,#FFD700 0%,#FFB300 25%,#FF9100 50%,#FFB300 75%,#FFD700 100%);
 background-size:200% 100%;
 animation:progressShine 2s linear infinite;
 box-shadow:0 0 20px rgba(255,215,0,0.7),0 0 40px rgba(255,215,0,0.3) inset;
 transition:width 0.3s ease;
}

/* CANVAS */
canvas{
 display:block;
 width:100%;
 height:100%;
 border-radius:20px;
 overflow:hidden;
 box-shadow:0 20px 40px rgba(0,0,0,0.4),0 0 0 2px rgba(255,215,0,0.2);
 -webkit-touch-callout:none;
}

/* BUTTONS */
.btn-momo{
 margin-top:20px;
 padding:16px 36px;
 border:none;
 border-radius:25px;
 font-size:18px;
 font-weight:800;
 background:linear-gradient(135deg,#FFD700 0%,#FFB300 50%,#FF9100 100%);
 color:#A50064;
 cursor:pointer;
 transition:all 0.3s ease;
 box-shadow:0 10px 25px rgba(165,0,100,0.4);
 font-family:inherit;
 letter-spacing:0.5px;
 position:relative;
 overflow:hidden;
 z-index:1;
 -webkit-appearance:none;
}
.btn-momo::before{
 content:'';
 position:absolute;
 top:0;
 left:-100%;
 width:100%;
 height:100%;
 background:linear-gradient(90deg,transparent,rgba(255,255,255,0.4),transparent);
 transition:0.6s;
 z-index:-1;
}
.btn-momo:hover{
 transform:translateY(-5px) scale(1.05);
 box-shadow:0 15px 35px rgba(165,0,100,0.6);
}
.btn-momo:hover::before{
 left:100%;
}
.btn-momo:active{
 transform:translateY(2px) scale(1);
}

/* √îNG B·ª§T */
#but{
 position:absolute;
 top:-200px;
 left:50%;
 transform:translateX(-50%);
 width:140px;
 opacity:0;
 transition:all 0.8s cubic-bezier(0.68,-0.55,0.265,1.55);
 z-index:15;
 filter:drop-shadow(0 10px 20px rgba(0,0,0,0.4));
 pointer-events:none;
}
#but.show{
 top:100px;
 opacity:1;
 transform:translateX(-50%) scale(1.1);
 animation:butFloat 3s ease-in-out infinite;
}
#but.hide{
 animation:butHide 0.5s ease forwards;
}

/* R·ªî C√Å */
#basketDrop{
 position:absolute;
 top:200px;
 left:50%;
 transform:translateX(-50%) scale(0);
 width:80px;
 opacity:0;
 z-index:16;
 pointer-events:none;
 filter:drop-shadow(0 10px 20px rgba(255,215,0,0.5));
 transition:opacity 0.6s cubic-bezier(0.2,0.8,0.3,1),transform 0.6s cubic-bezier(0.2,0.8,0.3,1);
}
#basketDrop.show{
 opacity:1;
 transform:translateX(-50%) scale(1);
 animation:basketBounce 0.6s ease;
}

/* GAME OVER */
#over{
 position:absolute;
 top:0;
 left:0;
 width:100%;
 height:100%;
 display:none;
 align-items:center;
 justify-content:flex-start;
 flex-direction:column;
 color:#fff;
 z-index:50;
 padding:30px;
 text-align:center;
 backdrop-filter:blur(10px);
 -webkit-backdrop-filter:blur(10px);
 overflow-y:auto;
 padding-bottom:100px;
 -webkit-overflow-scrolling:touch;
 background:linear-gradient(-45deg,rgba(165,0,100,0.95),rgba(214,0,110,0.95),rgba(255,0,119,0.95),rgba(255,51,153,0.95),rgba(165,0,100,0.95),rgba(214,0,110,0.95),rgba(255,0,119,0.95),rgba(255,51,153,0.95));
 background-size:400% 400%;
 animation:gradientFlow 8s ease infinite;
}
#over-content{
 display:flex;
 flex-direction:column;
 align-items:center;
 width:100%;
 max-width:340px;
 margin:0 auto;
}
#summary{
 background:rgba(255,255,255,0.15);
 backdrop-filter:blur(20px);
 -webkit-backdrop-filter:blur(20px);
 padding:25px;
 border-radius:25px;
 width:100%;
 margin-bottom:20px;
 text-align:center;
 border:2px solid rgba(255,255,255,0.25);
 box-shadow:0 20px 40px rgba(0,0,0,0.3);
}
.summary-item{
 display:flex;
 justify-content:space-between;
 align-items:center;
 margin-bottom:15px;
 padding-bottom:15px;
 border-bottom:1px solid rgba(255,255,255,0.2);
}
.summary-item:last-child{
 margin-bottom:0;
 padding-bottom:0;
 border-bottom:none;
}
.summary-value{
 font-size:24px;
 font-weight:bold;
 color:#FFD700;
 text-shadow:0 0 10px rgba(255,215,0,0.5);
}

/* VOUCHER POPUP */
#voucherPopup{
 display:none;
 background:linear-gradient(135deg,#FFD700 0%,#FFB300 100%);
 color:#A50064;
 padding:25px;
 border-radius:25px;
 width:100%;
 margin-bottom:20px;
 text-align:center;
 border:3px solid rgba(255,255,255,0.7);
 box-shadow:0 20px 40px rgba(0,0,0,0.4),0 0 50px rgba(255,215,0,0.5);
 position:relative;
 overflow:hidden;
}
#voucherPopup::before{
 content:'';
 position:absolute;
 top:-10px;
 left:-10px;
 right:-10px;
 bottom:-10px;
 background:conic-gradient(from 0deg,#FFD700,#FF9100,#FFD700,#FF9100,#FFD700);
 z-index:-1;
 filter:blur(20px);
 opacity:0.5;
}
#voucherPopup h3{
 margin-top:0;
 color:#A50064;
 font-size:26px;
 margin-bottom:15px;
}
.voucher-code{
 font-size:32px;
 font-weight:900;
 letter-spacing:3px;
 background:rgba(255,255,255,0.95);
 padding:20px;
 border-radius:15px;
 margin:20px 0;
 color:#A50064;
 border:3px dashed #A50064;
 font-family:'Courier New',monospace;
 text-shadow:0 2px 4px rgba(0,0,0,0.1);
 animation:codePulse 2s ease-in-out infinite;
}

/* NAME BOX */
#nameBox{
 background:rgba(255,255,255,0.15);
 backdrop-filter:blur(20px);
 -webkit-backdrop-filter:blur(20px);
 padding:25px;
 border-radius:25px;
 width:100%;
 margin-bottom:20px;
 text-align:center;
 border:2px solid rgba(255,255,255,0.25);
 box-shadow:0 20px 40px rgba(0,0,0,0.3);
}
#nameBox label{
 display:block;
 margin-bottom:10px;
 color:#FFD700;
 font-weight:bold;
 font-size:18px;
}
#playerName{
 width:100%;
 padding:15px;
 border-radius:15px;
 border:2px solid rgba(255,215,0,0.5);
 background:rgba(255,255,255,0.9);
 margin:10px 0 20px;
 font-size:16px;
 color:#A50064;
 font-weight:bold;
 text-align:center;
 -webkit-appearance:none;
}

/* LEADERBOARD */
#leaderboard{
 display:none;
 background:rgba(255,255,255,0.95);
 color:#A50064;
 border-radius:25px;
 width:100%;
 padding:25px;
 margin:20px 0;
 border:3px solid #FFD700;
 box-shadow:0 20px 40px rgba(0,0,0,0.3);
}
#leaderboard h3{
 margin-top:0;
 color:#A50064;
 text-align:center;
 margin-bottom:20px;
 padding-bottom:15px;
 border-bottom:2px solid rgba(165,0,100,0.3);
 font-size:24px;
}
.rank{
 display:flex;
 justify-content:space-between;
 align-items:center;
 padding:12px 15px;
 margin:8px 0;
 border-radius:12px;
 background:rgba(255,215,0,0.1);
 border-left:5px solid transparent;
}
.rank.you{
 font-weight:bold;
 color:#FF9100;
 background:rgba(255,215,0,0.3);
 border-left:5px solid #FFD700;
}
.rank-medal{
 font-size:20px;
 margin-right:10px;
}

/* N√öT CH∆†I L·∫†I */
#playAgainBtn{
 margin-top:20px;
 margin-bottom:10px;
 position:relative;
 z-index:10;
 width:100%;
 max-width:340px;
}

/* ANIMATIONS */
@keyframes progressShine{
 0%{background-position:-200% 0}
 100%{background-position:200% 0}
}

@keyframes butFloat{
 0%,100%{transform:translateX(-50%) translateY(0) scale(1.1)}
 50%{transform:translateX(-50%) translateY(-10px) scale(1.15)}
}

@keyframes butHide{
 0%{transform:translateX(-50%) translateY(0) scale(1.1);opacity:1}
 100%{transform:translateX(-50%) translateY(-100px) scale(0.5);opacity:0}
}

@keyframes basketBounce{
 0%{transform:translateX(-50%) scale(0)}
 60%{transform:translateX(-50%) scale(1.2)}
 100%{transform:translateX(-50%) scale(1)}
}

@keyframes codePulse{
 0%,100%{transform:scale(1);box-shadow:0 0 20px rgba(255,215,0,0.5)}
 50%{transform:scale(1.05);box-shadow:0 0 40px rgba(255,215,0,0.8)}
}

@keyframes shake{
 0%,100%{transform:translateX(0)}
 10%,30%,50%,70%,90%{transform:translateX(-5px)}
 20%,40%,60%,80%{transform:translateX(5px)}
}

/* ===== RESPONSIVE FIXES ===== */
/* Mobile Landscape */
@media (max-height: 500px) and (orientation: landscape) {
  #gameWrapper {
    max-height: 500px;
    transform: scale(0.8);
  }
  
  #hud {
    transform: scale(0.8);
    transform-origin: top left;
  }
  
  #progressBox {
    transform: scale(0.8);
    transform-origin: top left;
  }
}

/* iOS Safari 100vh fix */
@supports (-webkit-touch-callout: none) {
  body {
    height: -webkit-fill-available;
  }
  
  #gameWrapper {
    height: -webkit-fill-available;
  }
}

/* Safe area support */
@supports (padding: max(0px)) {
  #gameWrapper {
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
  }
  
  #over {
    padding-top: calc(env(safe-area-inset-top) + 30px);
    padding-bottom: calc(env(safe-area-inset-bottom) + 100px);
  }
}

/* Prevent text size adjustment */
html {
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
  height: 100%;
  overflow: hidden;
}

/* INTRO FIX SPECIFIC */
#start {
  background: #000;
}
#start img {
  max-width: 100%;
  max-height: 100%;
  object-fit: cover;
  display: block;
  margin: auto;
}

/* For very small screens */
@media (max-width: 360px) {
  #gameWrapper {
    max-width: 100vw;
    max-height: calc(100vw * (640/360));
  }
}

/* For very tall screens */
@media (max-height: 640px) {
  #gameWrapper {
    max-height: 100vh;
    max-width: calc(100vh * (360/640));
  }
}
</style>
</head>

<body>

<div id="gameWrapper">

<!-- START SCREEN -->
<div id="start" onclick="showInstruction()">
 <img src="assets/start.png" alt="MoMo Game" id="startImage">
</div>

<!-- INSTRUCTION SCREEN -->
<div id="instruction">
 <div id="instructionBox">
  <h2>C√ÅCH CH∆†I</h2>
  <ul>
   <li><b>üëàüëâ Tap tr√°i/ph·∫£i</b> ƒë·ªÉ ƒë·ªïi l√†n ƒë∆∞·ªùng</li>
   <li><b>ü™ô Thu th·∫≠p Xu</b> - T√≠ch lu·ªπ ƒë·ªïi qu√† MoMo</li>
   <li><b>üß∫ M·ªói 50 Xu</b> nh·∫≠n <b>1 Gi·ªè C√°</b></li>
   <li><b>‚ö° C√†ng nhi·ªÅu Xu</b> ‚Üí T·ªëc ƒë·ªô c√†ng nhanh</li>
   <li><b>‚ùå Tr√°nh ch∆∞·ªõng ng·∫°i v·∫≠t</b> (ƒë·ªì ƒÉn, coffe, cosmestic)</li>
   <li><b>üéÅ ƒê·∫°t 3 Gi·ªè C√°</b> ƒë·ªÉ nh·∫≠n Voucher MoMo</li>
  </ul>
  <button class="btn-momo" onclick="startGame()">üéÆ B·∫ÆT ƒê·∫¶U CH∆†I</button>
 </div>
</div>

<!-- CHARACTERS -->
<img id="but" src="assets/but.png" alt="√îng B·ª•t">
<img id="basketDrop" src="assets/basket.png" alt="Gi·ªè C√°">

<!-- HUD -->
<div id="hud">
 <div class="hud-item">
  <span class="hud-icon">üí∞</span>
  <span>Xu: <span id="coinEl" class="hud-value">0</span></span>
 </div>
 <div class="hud-item">
  <span class="hud-icon">üß∫</span>
  <span>Gi·ªè c√°: <span id="basketEl" class="hud-value">0</span></span>
 </div>
</div>

<!-- THANH PROGRESS -->
<div id="progressBox"><div id="progress"></div></div>

<!-- GAME OVER -->
<div id="over">
 <div id="over-content">
  <h2 style="color:#FFD700;font-size:36px;text-shadow:0 0 20px rgba(255,215,0,0.8);margin-bottom:30px;">üèÅ K·∫æT TH√öC</h2>
  
  <div id="summary">
   <div class="summary-item">
    <span>üí∞ XU THU ƒê∆Ø·ª¢C:</span>
    <span id="finalCoins" class="summary-value">0</span>
   </div>
   <div class="summary-item">
    <span>üß∫ GI·ªé C√Å:</span>
    <span id="finalBaskets" class="summary-value">0</span>
   </div>
   <div class="summary-item">
    <span>‚ö° T·ªêC ƒê·ªò CAO NH·∫§T:</span>
    <span id="finalSpeed" class="summary-value">0</span>
   </div>
  </div>

  <!-- VOUCHER POPUP -->
  <div id="voucherPopup">
   <h3>üéâ CH√öC M·ª™NG!</h3>
   <p>B·∫°n ƒë√£ ƒë·∫°t ƒë·ªß <b>3 Gi·ªè C√°</b> üéØ</p>
   <div class="voucher-code">MOMO-TET-2026</div>
   <small>S·ª≠ d·ª•ng m√£ trong v√≠ MoMo ƒë·ªÉ nh·∫≠n ∆∞u ƒë√£i ƒë·∫∑c bi·ªát! üßß</small>
  </div>

  <div id="nameBox">
   <label>üè∑ NH·∫¨P T√äN C·ª¶A B·∫†N</label>
   <input id="playerName" placeholder="T√™n ng∆∞·ªùi ch∆°i">
   <button class="btn-momo" onclick="saveScore()">üíæ L∆ØU K·∫æT QU·∫¢</button>
  </div>

  <div id="leaderboard">
   <h3>üèÜ B·∫¢NG X·∫æP H·∫†NG</h3>
   <div id="rankList"></div>
  </div>

  <!-- N√öT CH∆†I L·∫†I -->
  <button class="btn-momo" id="playAgainBtn" onclick="location.reload()">üîÑ CH∆†I L·∫†I</button>
 </div>
</div>

<canvas id="game" width="360" height="640"></canvas>
</div>

<script>
/* ===== FULLSCREEN FIXES ===== */
// Fix 100vh tr√™n mobile
function setVH() {
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}

// Scale game cho ph√π h·ª£p
function initializeGameSize() {
  const gameWrapper = document.getElementById('gameWrapper');
  const windowWidth = window.innerWidth;
  const windowHeight = window.innerHeight;
  
  // T√≠nh to√°n t·ª∑ l·ªá scale
  const targetRatio = 360 / 640;
  const currentRatio = windowWidth / windowHeight;
  
  let scale;
  if (currentRatio > targetRatio) {
    // M√†n h√¨nh r·ªông h∆°n -> scale theo chi·ªÅu cao
    scale = windowHeight / 640;
  } else {
    // M√†n h√¨nh cao h∆°n -> scale theo chi·ªÅu r·ªông
    scale = windowWidth / 360;
  }
  
  // Gi·ªõi h·∫°n scale
  if (scale > 1.2) {
    scale = 1.2; // Gi·ªõi h·∫°n ph√≥ng to t·ªëi ƒëa 1.2x
  }
  
  if (scale < 0.8) {
    scale = 0.8; // Gi·ªõi h·∫°n thu nh·ªè t·ªëi thi·ªÉu 0.8x
  }
  
  gameWrapper.style.transform = `scale(${scale})`;
  gameWrapper.style.transformOrigin = 'center center';
}

// Fix ri√™ng cho intro
function fixIntroSize() {
  const startImg = document.getElementById('startImage');
  
  if (startImg) {
    // Reset ƒë·ªÉ ·∫£nh hi·ªÉn th·ªã ƒë√∫ng
    startImg.style.width = '100%';
    startImg.style.height = '100%';
    startImg.style.objectFit = 'cover';
    startImg.style.display = 'block';
  }
}

/* ===== INITIALIZE ===== */
window.addEventListener('load', function() {
  setVH();
  initializeGameSize();
  fixIntroSize();
  
  // Fix cho iOS
  setTimeout(() => {
    setVH();
    initializeGameSize();
    fixIntroSize();
  }, 100);
});

window.addEventListener('resize', function() {
  setVH();
  initializeGameSize();
  fixIntroSize();
});

window.addEventListener('orientationchange', function() {
  setTimeout(() => {
    setVH();
    initializeGameSize();
    fixIntroSize();
  }, 150);
});

// Prevent zoom on double tap
document.addEventListener('touchstart', function(e) {
  if (e.touches.length > 1) {
    e.preventDefault();
  }
}, { passive: false });

// Prevent context menu on long press
document.addEventListener('contextmenu', function(e) {
  e.preventDefault();
  return false;
});

/* ===== INTRO ‚Üí INSTRUCTION ===== */
function showInstruction(){
 document.getElementById('start').style.display = 'none';
 document.getElementById('instruction').style.display = 'flex';
}

/* ===== AUTO CLEAR ===== */
const GAME_VERSION = "stable-5.0";
if(localStorage.getItem("game_version") !== GAME_VERSION){
 localStorage.removeItem("leaderboard");
 localStorage.setItem("game_version", GAME_VERSION);
}

/* ===== CANVAS SETUP ===== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

canvas.width = 360;
canvas.height = 640;

/* ===== IMAGES ===== */
const roadImg = new Image(); 
roadImg.src = "assets/road.png";

const playerImg = new Image(); 
playerImg.src = "assets/cotam-run.png";

const coinImg = new Image(); 
coinImg.src = "assets/coin.png";

const obstacleTypes = [
 { img: new Image(), size: 40, color: '#8B4513' },
 { img: new Image(), size: 44, color: '#654321' },
 { img: new Image(), size: 38, color: '#808080' }
];
obstacleTypes[0].img.src = "assets/obs-rock.png";
obstacleTypes[1].img.src = "assets/obs-log.png";
obstacleTypes[2].img.src = "assets/obs-pot.png";

const imagesToLoad = [roadImg, playerImg, coinImg, 
                     obstacleTypes[0].img, obstacleTypes[1].img, obstacleTypes[2].img];

/* ===== SOUNDS ===== */
const sCoin = new Audio("assets/coin.mp3");
const sBasket = new Audio("assets/basket.mp3");
const sHit = new Audio("assets/hit.mp3");

sCoin.volume = 0.3;
sBasket.volume = 0.4;
sHit.volume = 0.5;

// Unlock audio tr√™n mobile
document.addEventListener('touchstart', function() {
  const silentAudio = new Audio();
  silentAudio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==';
  silentAudio.play().catch(e => console.log("Audio unlock error"));
}, { once: true });

/* ===== GAME STATE ===== */
let run = false, coin = 0, basket = 0;
let baseSpeed = 3.5, speed = baseSpeed, speedStep = 0.7, maxSpeed = 9;
let roadY = 0;
const lanes = [60, 180, 300];
let player = { lane: 1, y: 520 };
let coins = [], obstacles = [];
let coinTimer = 0, obstacleTimer = 0;
let frameCount = 0;
let butTimeout = null;

/* SPRITE ANIMATION */
const RUN_FRAMES = 4;
let runFrame = 0, runTick = 0;
let SW = 0, SH = 0;
playerImg.onload = () => {
 SW = playerImg.width / RUN_FRAMES;
 SH = playerImg.height;
};

/* ===== START GAME ===== */
function startGame(){
 document.getElementById('instruction').style.display = 'none';
 run = true;
 
 // Kh·ªüi ƒë·ªông audio
 if (sCoin) sCoin.play().catch(e => console.log("Audio error:", e));
 
 loop();
}

/* CONTROL */
canvas.addEventListener("touchstart", function(e) {
 e.preventDefault();
 const touch = e.touches[0];
 const rect = canvas.getBoundingClientRect();
 const touchX = touch.clientX - rect.left;
 
 const oldLane = player.lane;
 player.lane = touchX < rect.width / 2 ? Math.max(0, player.lane - 1) : Math.min(2, player.lane + 1);
});

/* SPAWN COINS */
const spawnCoin = () => {
 const lane = Math.floor(Math.random() * 3);
 const coinObj = {
  lane,
  y: -40,
  angle: Math.random() * Math.PI * 2,
  scale: 0.8 + Math.random() * 0.4,
  pulse: Math.random() * Math.PI * 2
 };
 coins.push(coinObj);
};

/* SPAWN OBSTACLES */
const spawnObstacleWave = () => {
 const freeLane = Math.floor(Math.random() * 3);
 for(let l = 0; l < 3; l++) {
  if(l !== freeLane && Math.random() < 0.7) {
   const type = Math.floor(Math.random() * obstacleTypes.length);
   obstacles.push({
    lane: l,
    y: -60,
    type,
    phase: Math.random() * Math.PI * 2,
    shakeIntensity: 1 + Math.random() * 2,
    shakeSpeed: 0.08 + Math.random() * 0.15,
    rotation: Math.random() * 0.3 - 0.15,
    scale: 0.9 + Math.random() * 0.2,
    spawnTime: frameCount
   });
  }
 }
};

/* MAIN GAME LOOP */
function loop(){
 if(!run) return;
 frameCount++;
 
 ctx.clearRect(0, 0, 360, 640);
 
 /* DRAW ROAD */
 roadY += speed;
 if(roadY >= 640) roadY = 0;
 
 ctx.drawImage(roadImg, 0, roadY - 640, 360, 640);
 ctx.drawImage(roadImg, 0, roadY, 360, 640);
 
 /* DRAW LANE MARKERS */
 ctx.strokeStyle = 'rgba(255, 215, 0, 0.3)';
 ctx.lineWidth = 2;
 ctx.setLineDash([20, 20]);
 for(let i = 0; i < lanes.length; i++) {
  ctx.beginPath();
  ctx.moveTo(lanes[i] - 60, 0);
  ctx.lineTo(lanes[i] - 60, 640);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(lanes[i] + 60, 0);
  ctx.lineTo(lanes[i] + 60, 640);
  ctx.stroke();
 }
 ctx.setLineDash([]);
 
 /* DRAW PLAYER */
 runTick++;
 if(runTick % 6 === 0) runFrame = (runFrame + 1) % RUN_FRAMES;
 
 if(SW){
  ctx.drawImage(
   playerImg,
   runFrame * SW, 0, SW, SH,
   lanes[player.lane] - 22, player.y - 50, 44, 66
  );
 }
 
 /* DRAW COINS */
 for(let i = coins.length - 1; i >= 0; i--){
  const c = coins[i];
  c.y += speed;
  c.angle += 0.1;
  c.pulse += 0.1;
  
  const pulseScale = 0.1 * Math.sin(c.pulse);
  
  ctx.save();
  ctx.translate(lanes[c.lane], c.y);
  ctx.rotate(c.angle);
  ctx.scale(c.scale + pulseScale, c.scale + pulseScale);
  
  ctx.shadowColor = '#FFD700';
  ctx.shadowBlur = 20;
  ctx.drawImage(coinImg, -15, -15, 30, 30);
  ctx.restore();
  
  if(c.lane === player.lane && Math.abs(c.y - player.y) < 40){
   coins.splice(i, 1);
   coin++;
   document.getElementById('coinEl').innerText = coin;
   
   sCoin.currentTime = 0;
   sCoin.play().catch(e => console.log("Audio error:", e));
   
   const milestone = Math.floor(coin / 50);
   if(milestone > basket){
    basket = milestone;
    document.getElementById('basketEl').innerText = basket;
    
    sBasket.currentTime = 0;
    sBasket.play().catch(e => console.log("Audio error:", e));
    
    const butElement = document.getElementById('but');
    butElement.classList.add('show');
    
    if (butTimeout) {
      clearTimeout(butTimeout);
    }
    
    butTimeout = setTimeout(() => {
      butElement.classList.add('hide');
      setTimeout(() => {
        butElement.classList.remove('show', 'hide');
        butElement.style.top = '-200px';
        butElement.style.opacity = '0';
      }, 500);
    }, 2000);
    
    const basketElement = document.getElementById('basketDrop');
    basketElement.classList.add('show');
    
    setTimeout(() => {
      basketElement.classList.remove('show');
      basketElement.style.opacity = '0';
      basketElement.style.transform = 'translateX(-50%) scale(0)';
    }, 1000);
   }
   
   speed = Math.min(baseSpeed + milestone * speedStep, maxSpeed);
   document.getElementById('progress').style.width = ((coin % 50) / 50 * 100) + "%";
  }
 }
 
 /* DRAW OBSTACLES */
 for(let i = obstacles.length - 1; i >= 0; i--){
  const o = obstacles[i];
  const t = obstacleTypes[o.type];
  o.y += speed;
  o.phase += o.shakeSpeed;
  
  const shakeX = Math.sin(o.phase) * o.shakeIntensity;
  const shakeY = Math.cos(o.phase * 1.5) * (o.shakeIntensity * 0.8);
  
  const age = frameCount - o.spawnTime;
  const blink = age < 60 ? (Math.sin(age * 0.3) * 0.5 + 0.5) : 1;
  
  ctx.save();
  ctx.translate(lanes[o.lane] + shakeX, o.y + shakeY);
  ctx.rotate(o.rotation);
  ctx.scale(o.scale, o.scale);
  ctx.globalAlpha = blink;
  
  ctx.shadowColor = t.color;
  ctx.shadowBlur = 15;
  ctx.drawImage(t.img, -t.size/2, -t.size/2, t.size, t.size);
  ctx.restore();
  
  if(o.lane === player.lane && Math.abs(o.y - player.y) < 35){
   endGame(); 
   return;
  }
 }
 
 coinTimer++; 
 obstacleTimer++;
 
 if(coinTimer > 25){
  spawnCoin(); 
  coinTimer = 0;
 }
 if(obstacleTimer > 75){
  spawnObstacleWave(); 
  obstacleTimer = 0;
 }
 
 requestAnimationFrame(loop);
}

function endGame(){
 run = false;
 sHit.play().catch(e => console.log("Audio error:", e));
 
 document.getElementById('finalCoins').textContent = coin;
 document.getElementById('finalBaskets').textContent = basket;
 document.getElementById('finalSpeed').textContent = speed.toFixed(1);
 
 const butElement = document.getElementById('but');
 if (butElement.classList.contains('show')) {
   butElement.classList.remove('show');
   butElement.classList.add('hide');
   setTimeout(() => {
     butElement.classList.remove('hide');
     butElement.style.top = '-200px';
     butElement.style.opacity = '0';
   }, 500);
 }
 
 if (butTimeout) {
   clearTimeout(butTimeout);
   butTimeout = null;
 }
 
 const gameWrapper = document.getElementById('gameWrapper');
 gameWrapper.style.animation = 'shake 0.5s ease';
 setTimeout(() => {
  gameWrapper.style.animation = '';
 }, 500);
 
 setTimeout(() => {
  document.getElementById('over').style.display = 'flex';
  
  if(basket >= 3){
   document.getElementById('voucherPopup').style.display = 'block';
  }
 }, 1000);
}

/* SAVE SCORE */
function saveScore(){
 const name = document.getElementById('playerName').value.trim() || "Ng∆∞·ªùi Ch∆°i";
 let lb = JSON.parse(localStorage.getItem("leaderboard") || "[]");
 
 lb.push({
  name, 
  coin,
  basket,
  speed: speed.toFixed(1),
  date: new Date().toLocaleDateString('vi-VN')
 });
 
 lb.sort((a, b) => b.coin - a.coin);
 
 lb = lb.slice(0, 8);
 
 localStorage.setItem("leaderboard", JSON.stringify(lb));
 
 document.getElementById('nameBox').style.display = 'none';
 document.getElementById('leaderboard').style.display = 'block';
 
 document.getElementById('playAgainBtn').style.display = 'block';
 
 const rankList = document.getElementById('rankList');
 rankList.innerHTML = '';
 
 // Header
 const header = document.createElement('div');
 header.className = 'rank';
 header.style.background = 'rgba(255, 215, 0, 0.3)';
 header.style.fontWeight = 'bold';
 header.innerHTML = `
  <span>T√äN</span>
  <span>XU</span>
  <span>GI·ªé</span>
 `;
 rankList.appendChild(header);
 
 // Ranks
 lb.forEach((r, i) => {
  const rankDiv = document.createElement('div');
  rankDiv.className = `rank ${r.name === name && r.coin === coin ? 'you' : ''}`;
  
  let medal = '';
  if(i === 0) medal = 'ü•á';
  else if(i === 1) medal = 'ü•à';
  else if(i === 2) medal = 'ü•â';
  
  rankDiv.innerHTML = `
   <span>${medal} ${r.name}</span>
   <span>üí∞ ${r.coin}</span>
   <span>üß∫ ${r.basket}</span>
  `;
  rankList.appendChild(rankDiv);
 });
}

// Preload images v√† ki·ªÉm tra l·ªói
window.addEventListener('load', function() {
  let loadedImages = 0;
  const totalImages = imagesToLoad.length;
  
  // Debug log
  console.log('B·∫Øt ƒë·∫ßu t·∫£i h√¨nh ·∫£nh...');
  
  imagesToLoad.forEach(img => {
    // Thi·∫øt l·∫≠p onload
    img.onload = function() {
      loadedImages++;
      console.log(`ƒê√£ t·∫£i: ${img.src}`);
      if (loadedImages === totalImages) {
        console.log('‚úì T·∫•t c·∫£ h√¨nh ·∫£nh ƒë√£ ƒë∆∞·ª£c t·∫£i th√†nh c√¥ng!');
      }
    };
    
    // Thi·∫øt l·∫≠p onerror
    img.onerror = function() {
      console.error(`‚ùå L·ªói khi t·∫£i h√¨nh ·∫£nh: ${img.src}`);
      // Th·ª≠ t·∫£i l·∫°i v·ªõi ƒë∆∞·ªùng d·∫´n thay th·∫ø
      console.log(`Th·ª≠ t·∫£i l·∫°i: ${img.src}`);
    };
  });
  
  // Ki·ªÉm tra sau 3 gi√¢y n·∫øu h√¨nh ·∫£nh ch∆∞a t·∫£i xong
  setTimeout(() => {
    if (loadedImages < totalImages) {
      console.warn(`C·∫£nh b√°o: Ch·ªâ t·∫£i ƒë∆∞·ª£c ${loadedImages}/${totalImages} h√¨nh ·∫£nh`);
      console.log('Danh s√°ch h√¨nh ·∫£nh c·∫ßn t·∫£i:');
      imagesToLoad.forEach(img => {
        console.log(`- ${img.src}: ${img.complete ? '‚úì ƒê√£ t·∫£i' : '‚úó Ch∆∞a t·∫£i'}`);
      });
    }
  }, 3000);
});

// Fix l·ªói touch tr√™n canvas cho mobile
canvas.addEventListener('touchstart', handleTouch, { passive: false });
canvas.addEventListener('touchmove', handleTouch, { passive: false });

function handleTouch(e) {
  if (e.cancelable) e.preventDefault();
}

// ƒê·∫£m b·∫£o game ch·∫°y ngay c·∫£ khi c√≥ l·ªói nh·ªè
window.addEventListener('error', function(e) {
  console.error('L·ªói JavaScript:', e.message);
  console.error('T·∫°i d√≤ng:', e.lineno);
  console.error('Trong file:', e.filename);
});
</script>
</body>
</html>

