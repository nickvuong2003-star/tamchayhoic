<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Nh·∫∑t ƒê·ªìng Nh·ªè - V√≠ MoMo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#A50064">

<style>
/* CSS Variables */
:root {
  --vh: 1vh;
}

/* Reset */
*{box-sizing:border-box;margin:0;padding:0}

/* Body - Fullscreen */
body{
 margin:0;
 padding:0;
 background:#000;
 overflow:hidden;
 font-family:'Segoe UI', system-ui, -apple-system, sans-serif;
 display:flex;
 align-items:center;
 justify-content:center;
 min-height:100vh;
 min-height:calc(var(--vh, 1vh) * 100);
 background: linear-gradient(135deg, #1a0033 0%, #330066 50%, #4d0099 100%);
 position:fixed;
 top:0;
 left:0;
 right:0;
 bottom:0;
 width:100vw;
 height:100vh;
 height:calc(var(--vh, 1vh) * 100);
 -webkit-tap-highlight-color:transparent;
 touch-action:none;
 -webkit-user-select:none;
 user-select:none;
}

/* GAME WRAPPER */
#gameWrapper{
 position:relative;
 width:100%;
 height:100%;
 max-width:360px;
 max-height:640px;
 margin:auto;
 transform-origin:center center;
 filter:drop-shadow(0 10px 30px rgba(0,0,0,0.5));
 touch-action:manipulation;
 overflow:hidden;
 display:flex;
 align-items:center;
 justify-content:center;
}

/* INTRO SCREEN - FIXED */
#start{
 position:absolute;
 top:0;
 left:0;
 width:100%;
 height:100%;
 z-index:50;
 cursor:pointer;
 background:#000;
 display:flex;
 align-items:center;
 justify-content:center;
 overflow:hidden;
}
#start img{
 width:100%;
 height:100%;
 object-fit:cover;
 pointer-events:none;
 display:block;
 margin:auto;
 max-width:100%;
 max-height:100%;
}

/* INSTRUCTION SCREEN */
#instruction{
 position:absolute;
 top:0;
 left:0;
 width:100%;
 height:100%;
 color:#fff;
 display:none;
 flex-direction:column;
 align-items:center;
 justify-content:center;
 padding:20px;
 z-index:40;
 text-align:center;
 background:linear-gradient(-45deg,#A50064,#D6006E,#FF0077,#FF3399,#A50064,#D6006E,#FF0077,#FF3399);
 background-size:400% 400%;
 animation:gradientFlow 8s ease infinite;
}
@keyframes gradientFlow{
 0%{background-position:0% 50%}
 50%{background-position:100% 50%}
 100%{background-position:0% 50%}
}

#instructionBox{
 background:rgba(255,255,255,0.15);
 backdrop-filter:blur(20px);
 -webkit-backdrop-filter:blur(20px);
 border:2px solid rgba(255,255,255,0.25);
 padding:30px;
 border-radius:25px;
 max-width:320px;
 width:90%;
 box-shadow:0 20px 40px rgba(0,0,0,0.3),0 0 0 1px rgba(255,255,255,0.1) inset;
}
#instructionBox h2{
 margin-top:0;
 color:#fff;
 font-size:28px;
 text-shadow:0 2px 10px rgba(0,0,0,0.3);
 margin-bottom:25px;
 padding-bottom:15px;
 border-bottom:2px solid rgba(255,255,255,0.3);
 position:relative;
}
#instructionBox h2::after{
 content:'';
 position:absolute;
 bottom:-2px;
 left:50%;
 transform:translateX(-50%);
 width:100px;
 height:3px;
 background:linear-gradient(90deg,transparent,#FFD700,transparent);
}
#instructionBox ul{
 text-align:left;
 padding-left:25px;
 line-height:1.7;
 color:#fff;
 font-size:16px;
 margin-bottom:25px;
 list-style:none;
}
#instructionBox li{
 margin-bottom:16px;
 padding-left:35px;
 position:relative;
}
#instructionBox li::before{
 content:'';
 position:absolute;
 left:0;
 top:50%;
 transform:translateY(-50%);
 width:24px;
 height:24px;
 background:rgba(255,215,0,0.2);
 border-radius:50%;
 border:2px solid #FFD700;
}
#instructionBox li::after{
 content:'‚úì';
 position:absolute;
 left:0;
 top:50%;
 transform:translateY(-50%);
 width:24px;
 height:24px;
 color:#FFD700;
 font-weight:bold;
 text-align:center;
 line-height:24px;
}
#instructionBox b{
 color:#FFD700;
 font-weight:800;
 text-shadow:0 0 10px rgba(255,215,0,0.5);
}

/* HUD */
#hud{
 position:absolute;
 top:20px;
 left:20px;
 color:#fff;
 font-weight:bold;
 z-index:10;
 background:rgba(165,0,100,0.85);
 padding:15px 20px;
 border-radius:20px;
 border:2px solid rgba(255,215,0,0.3);
 box-shadow:0 10px 20px rgba(0,0,0,0.3);
 backdrop-filter:blur(10px);
 -webkit-backdrop-filter:blur(10px);
}
.hud-item{
 display:flex;
 align-items:center;
 gap:10px;
 margin-bottom:10px;
}
.hud-item:last-child{
 margin-bottom:0;
}
.hud-icon{
 font-size:24px;
 filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}
.hud-value{
 font-size:24px;
 color:#FFD700;
 text-shadow:0 0 10px rgba(255,215,0,0.5);
}

/* N√öT √ÇM THANH */
#soundBtn{
 position:absolute;
 top:20px;
 right:20px;
 width:44px;
 height:44px;
 background:rgba(165,0,100,0.85);
 border-radius:50%;
 border:2px solid rgba(255,215,0,0.3);
 display:flex;
 align-items:center;
 justify-content:center;
 cursor:pointer;
 z-index:11;
 backdrop-filter:blur(10px);
 -webkit-backdrop-filter:blur(10px);
 box-shadow:0 5px 15px rgba(0,0,0,0.3);
 transition:all 0.3s ease;
}
#soundBtn:hover{
 transform:scale(1.1);
}
#soundIcon{
 font-size:22px;
 color:#FFD700;
 filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

/* PROGRESS */
#progressBox{
 position:absolute;
 top:145px;
 left:20px;
 width:200px;
 height:16px;
 background:rgba(255,255,255,0.1);
 border-radius:10px;
 overflow:hidden;
 border:2px solid rgba(255,255,255,0.2);
 box-shadow:0 5px 15px rgba(0,0,0,0.2);
}
#progress{
 height:100%;
 width:0%;
 background:linear-gradient(90deg,#FFD700 0%,#FFB300 25%,#FF9100 50%,#FFB300 75%,#FFD700 100%);
 background-size:200% 100%;
 animation:progressShine 2s linear infinite;
 box-shadow:0 0 20px rgba(255,215,0,0.7),0 0 40px rgba(255,215,0,0.3) inset;
 transition:width 0.3s ease;
}

/* CANVAS */
canvas{
 display:block;
 width:100%;
 height:100%;
 border-radius:20px;
 overflow:hidden;
 box-shadow:0 20px 40px rgba(0,0,0,0.4),0 0 0 2px rgba(255,215,0,0.2);
 -webkit-touch-callout:none;
}

/* BUTTONS */
.btn-momo{
 margin-top:20px;
 padding:16px 36px;
 border:none;
 border-radius:25px;
 font-size:18px;
 font-weight:800;
 background:linear-gradient(135deg,#FFD700 0%,#FFB300 50%,#FF9100 100%);
 color:#A50064;
 cursor:pointer;
 transition:all 0.3s ease;
 box-shadow:0 10px 25px rgba(165,0,100,0.4);
 font-family:inherit;
 letter-spacing:0.5px;
 position:relative;
 overflow:hidden;
 z-index:1;
 -webkit-appearance:none;
}
.btn-momo::before{
 content:'';
 position:absolute;
 top:0;
 left:-100%;
 width:100%;
 height:100%;
 background:linear-gradient(90deg,transparent,rgba(255,255,255,0.4),transparent);
 transition:0.6s;
 z-index:-1;
}
.btn-momo:hover{
 transform:translateY(-5px) scale(1.05);
 box-shadow:0 15px 35px rgba(165,0,100,0.6);
}
.btn-momo:hover::before{
 left:100%;
}
.btn-momo:active{
 transform:translateY(2px) scale(1);
}

/* √îNG B·ª§T */
#but{
 position:absolute;
 top:-200px;
 left:50%;
 transform:translateX(-50%);
 width:140px;
 opacity:0;
 transition:all 0.8s cubic-bezier(0.68,-0.55,0.265,1.55);
 z-index:15;
 filter:drop-shadow(0 10px 20px rgba(0,0,0,0.4));
 pointer-events:none;
}
#but.show{
 top:100px;
 opacity:1;
 transform:translateX(-50%) scale(1.1);
 animation:butFloat 3s ease-in-out infinite;
}
#but.hide{
 animation:butHide 0.5s ease forwards;
}

/* R·ªî C√Å */
#basketDrop{
 position:absolute;
 top:200px;
 left:50%;
 transform:translateX(-50%) scale(0);
 width:80px;
 opacity:0;
 z-index:16;
 pointer-events:none;
 filter:drop-shadow(0 10px 20px rgba(255,215,0,0.5));
 transition:opacity 0.6s cubic-bezier(0.2,0.8,0.3,1),transform 0.6s cubic-bezier(0.2,0.8,0.3,1);
}
#basketDrop.show{
 opacity:1;
 transform:translateX(-50%) scale(1);
 animation:basketBounce 0.6s ease;
}

/* GAME OVER */
#over{
 position:absolute;
 top:0;
 left:0;
 width:100%;
 height:100%;
 display:none;
 align-items:center;
 justify-content:flex-start;
 flex-direction:column;
 color:#fff;
 z-index:50;
 padding:30px;
 text-align:center;
 backdrop-filter:blur(10px);
 -webkit-backdrop-filter:blur(10px);
 overflow-y:auto;
 padding-bottom:100px;
 -webkit-overflow-scrolling:touch;
 background:linear-gradient(-45deg,rgba(165,0,100,0.95),rgba(214,0,110,0.95),rgba(255,0,119,0.95),rgba(255,51,153,0.95),rgba(165,0,100,0.95),rgba(214,0,110,0.95),rgba(255,0,119,0.95),rgba(255,51,153,0.95));
 background-size:400% 400%;
 animation:gradientFlow 8s ease infinite;
}
#over-content{
 display:flex;
 flex-direction:column;
 align-items:center;
 width:100%;
 max-width:340px;
 margin:0 auto;
}
#summary{
 background:rgba(255,255,255,0.15);
 backdrop-filter:blur(20px);
 -webkit-backdrop-filter:blur(20px);
 padding:25px;
 border-radius:25px;
 width:100%;
 margin-bottom:20px;
 text-align:center;
 border:2px solid rgba(255,255,255,0.25);
 box-shadow:0 20px 40px rgba(0,0,0,0.3);
}
.summary-item{
 display:flex;
 justify-content:space-between;
 align-items:center;
 margin-bottom:15px;
 padding-bottom:15px;
 border-bottom:1px solid rgba(255,255,255,0.2);
}
.summary-item:last-child{
 margin-bottom:0;
 padding-bottom:0;
 border-bottom:none;
}
.summary-value{
 font-size:24px;
 font-weight:bold;
 color:#FFD700;
 text-shadow:0 0 10px rgba(255,215,0,0.5);
}

/* VOUCHER POPUP - H√åNH ·∫¢NH FILL TO√ÄN B·ªò CONTAINER */
#voucherPopup{
 display:none;
 background:linear-gradient(135deg,#FFD700 0%,#FFB300 100%);
 color:#A50064;
 padding:25px;
 border-radius:25px;
 width:100%;
 margin-bottom:20px;
 text-align:center;
 border:3px solid rgba(255,255,255,0.7);
 box-shadow:0 20px 40px rgba(0,0,0,0.4),0 0 50px rgba(255,215,0,0.5);
 position:relative;
 overflow:hidden;
}
#voucherPopup::before{
 content:'';
 position:absolute;
 top:-10px;
 left:-10px;
 right:-10px;
 bottom:-10px;
 background:conic-gradient(from 0deg,#FFD700,#FF9100,#FFD700,#FF9100,#FFD700);
 z-index:-1;
 filter:blur(20px);
 opacity:0.5;
}
#voucherPopup h3{
 margin-top:0;
 color:#A50064;
 font-size:26px;
 margin-bottom:15px;
}
/* CONTAINER CHO H√åNH VOUCHER - V·ªöI K√çCH TH∆Ø·ªöC C·ªê ƒê·ªäNH */
.voucher-image-container{
 width:100%;
 height:220px; /* TƒÉng chi·ªÅu cao ƒë·ªÉ hi·ªÉn th·ªã r√µ h∆°n */
 margin:15px 0;
 border-radius:15px;
 overflow:hidden;
 box-shadow:0 10px 25px rgba(165,0,100,0.4);
 border:3px solid rgba(255,255,255,0.8);
 position:relative;
 background:rgba(255,255,255,0.9);
 display:flex;
 align-items:center;
 justify-content:center;
}
/* H√¨nh ·∫£nh voucher - FILL TO√ÄN B·ªò CONTAINER */
.voucher-image{
 width:100%;
 height:100%;
 object-fit:cover; /* Thay ƒë·ªïi t·ª´ 'contain' th√†nh 'cover' ƒë·ªÉ fill container */
 display:block;
 position:absolute;
 top:0;
 left:0;
}
/* X√≥a c√°c class c≈© v·ªÅ k√≠ch th∆∞·ªõc v√¨ gi·ªù ƒë√£ fill container */
.voucher-image.square,
.voucher-image.landscape,
.voucher-image.portrait {
  /* T·∫•t c·∫£ s·∫Ω fill container */
}

.voucher-code{
 font-size:28px;
 font-weight:900;
 letter-spacing:3px;
 background:rgba(255,255,255,0.95);
 padding:15px;
 border-radius:15px;
 margin:15px 0;
 color:#A50064;
 border:3px dashed #A50064;
 font-family:'Courier New',monospace;
 text-shadow:0 2px 4px rgba(0,0,0,0.1);
 animation:codePulse 2s ease-in-out infinite;
}
.voucher-desc{
 font-size:14px;
 margin-top:10px;
 color:#A50064;
 font-weight:bold;
}
.voucher-brand{
 font-size:20px;
 font-weight:900;
 margin:10px 0;
 text-transform:uppercase;
 letter-spacing:1px;
}
.voucher-value{
 font-size:24px;
 font-weight:900;
 color:#A50064;
 margin:10px 0;
 background:rgba(255,255,255,0.9);
 padding:8px 15px;
 border-radius:10px;
 display:inline-block;
}

/* NAME BOX */
#nameBox{
 background:rgba(255,255,255,0.15);
 backdrop-filter:blur(20px);
 -webkit-backdrop-filter:blur(20px);
 padding:25px;
 border-radius:25px;
 width:100%;
 margin-bottom:20px;
 text-align:center;
 border:2px solid rgba(255,255,255,0.25);
 box-shadow:0 20px 40px rgba(0,0,0,0.3);
}
#nameBox label{
 display:block;
 margin-bottom:10px;
 color:#FFD700;
 font-weight:bold;
 font-size:18px;
}
#playerName{
 width:100%;
 padding:15px;
 border-radius:15px;
 border:2px solid rgba(255,215,0,0.5);
 background:rgba(255,255,255,0.9);
 margin:10px 0 20px;
 font-size:16px;
 color:#A50064;
 font-weight:bold;
 text-align:center;
 -webkit-appearance:none;
}

/* LEADERBOARD */
#leaderboard{
 display:none;
 background:rgba(255,255,255,0.95);
 color:#A50064;
 border-radius:25px;
 width:100%;
 padding:25px;
 margin:20px 0;
 border:3px solid #FFD700;
 box-shadow:0 20px 40px rgba(0,0,0,0.3);
}
#leaderboard h3{
 margin-top:0;
 color:#A50064;
 text-align:center;
 margin-bottom:20px;
 padding-bottom:15px;
 border-bottom:2px solid rgba(165,0,100,0.3);
 font-size:24px;
}
.rank{
 display:flex;
 justify-content:space-between;
 align-items:center;
 padding:12px 15px;
 margin:8px 0;
 border-radius:12px;
 background:rgba(255,215,0,0.1);
 border-left:5px solid transparent;
}
.rank.you{
 font-weight:bold;
 color:#FF9100;
 background:rgba(255,215,0,0.3);
 border-left:5px solid #FFD700;
}
.rank-medal{
 font-size:20px;
 margin-right:10px;
}

/* N√öT CH∆†I L·∫†I */
#playAgainBtn{
 margin-top:20px;
 margin-bottom:10px;
 position:relative;
 z-index:10;
 width:100%;
 max-width:340px;
}

/* ANIMATIONS */
@keyframes progressShine{
 0%{background-position:-200% 0}
 100%{background-position:200% 0}
}

@keyframes butFloat{
 0%,100%{transform:translateX(-50%) translateY(0) scale(1.1)}
 50%{transform:translateX(-50%) translateY(-10px) scale(1.15)}
}

@keyframes butHide{
 0%{transform:translateX(-50%) translateY(0) scale(1.1);opacity:1}
 100%{transform:translateX(-50%) translateY(-100px) scale(0.5);opacity:0}
}

@keyframes basketBounce{
 0%{transform:translateX(-50%) scale(0)}
 60%{transform:translateX(-50%) scale(1.2)}
 100%{transform:translateX(-50%) scale(1)}
}

@keyframes codePulse{
 0%,100%{transform:scale(1);box-shadow:0 0 20px rgba(255,215,0,0.5)}
 50%{transform:scale(1.05);box-shadow:0 0 40px rgba(255,215,0,0.8)}
}

@keyframes shake{
 0%,100%{transform:translateX(0)}
 10%,30%,50%,70%,90%{transform:translateX(-5px)}
 20%,40%,60%,80%{transform:translateX(5px)}
}

@keyframes sparkle {
  0% { transform: translateY(0) rotate(0deg); opacity: 0; }
  50% { opacity: 1; }
  100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

@keyframes shine {
  0% { background-position: -200% center; }
  100% { background-position: 200% center; }
}

/* NH√ÇN V·∫¨T L·ªöN H∆†N */
.player-shadow {
  position: absolute;
  bottom: 505px;
  left: 50%;
  transform: translateX(-50%);
  width: 60px;
  height: 20px;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 50%;
  filter: blur(5px);
  z-index: 5;
  pointer-events: none;
}

/* ===== RESPONSIVE FIXES ===== */
/* Mobile Landscape */
@media (max-height: 500px) and (orientation: landscape) {
  #gameWrapper {
    max-height: 500px;
    transform: scale(0.8);
  }
  
  #hud {
    transform: scale(0.8);
    transform-origin: top left;
  }
  
  #soundBtn {
    transform: scale(0.8);
    transform-origin: top right;
  }
  
  #progressBox {
    transform: scale(0.8);
    transform-origin: top left;
  }
  
  .voucher-image-container {
    height: 140px; /* Gi·∫£m chi·ªÅu cao trong landscape */
  }
  
  .voucher-code {
    font-size: 20px;
    padding: 10px;
  }
  
  .voucher-brand {
    font-size: 16px;
  }
  
  .voucher-value {
    font-size: 18px;
  }
}

/* iOS Safari 100vh fix */
@supports (-webkit-touch-callout: none) {
  body {
    height: -webkit-fill-available;
  }
  
  #gameWrapper {
    height: -webkit-fill-available;
  }
}

/* Safe area support */
@supports (padding: max(0px)) {
  #gameWrapper {
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
  }
  
  #over {
    padding-top: calc(env(safe-area-inset-top) + 30px);
    padding-bottom: calc(env(safe-area-inset-bottom) + 100px);
  }
  
  #soundBtn {
    top: calc(env(safe-area-inset-top) + 20px);
    right: calc(env(safe-area-inset-right) + 20px);
  }
}

/* Prevent text size adjustment */
html {
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
  height: 100%;
  overflow: hidden;
}

/* INTRO FIX SPECIFIC */
#start {
  background: #000;
}
#start img {
  max-width: 100%;
  max-height: 100%;
  object-fit: cover;
  display: block;
  margin: auto;
}

/* For very small screens */
@media (max-width: 360px) {
  #gameWrapper {
    max-width: 100vw;
    max-height: calc(100vw * (640/360));
  }
  
  .voucher-image-container {
    height: 180px; /* ƒêi·ªÅu ch·ªânh cho m√†n h√¨nh nh·ªè */
  }
  
  .voucher-code {
    font-size: 22px;
    padding: 12px;
  }
  
  .voucher-brand {
    font-size: 18px;
  }
  
  .voucher-value {
    font-size: 20px;
  }
}

/* For very tall screens */
@media (max-height: 640px) {
  #gameWrapper {
    max-height: 100vh;
    max-width: calc(100vh * (360/640));
  }
  
  .voucher-image-container {
    height: 180px; /* ƒêi·ªÅu ch·ªânh cho m√†n h√¨nh cao */
  }
}

/* Cho m√†n h√¨nh r·∫•t nh·ªè */
@media (max-width: 320px) {
  .voucher-image-container {
    height: 160px;
  }
  
  .voucher-code {
    font-size: 20px;
    padding: 10px;
  }
  
  .voucher-brand {
    font-size: 16px;
  }
  
  .voucher-value {
    font-size: 18px;
  }
}

/* Cho m√†n h√¨nh l·ªõn h∆°n */
@media (min-width: 361px) and (min-height: 641px) {
  .voucher-image-container {
    height: 240px; /* TƒÉng chi·ªÅu cao cho m√†n h√¨nh l·ªõn */
  }
}
</style>
</head>

<body>

<div id="gameWrapper">

<!-- START SCREEN -->
<div id="start" onclick="showInstruction()">
 <img src="assets/start.png" alt="MoMo Game" id="startImage">
</div>

<!-- N√öT √ÇM THANH -->
<div id="soundBtn" onclick="toggleSound()">
 <span id="soundIcon">üîä</span>
</div>

<!-- INSTRUCTION SCREEN -->
<div id="instruction">
 <div id="instructionBox">
  <h2>C√ÅCH CH∆†I</h2>
  <ul>
   <li><b>üëàüëâ Tap tr√°i/ph·∫£i</b> ƒë·ªÉ ƒë·ªïi l√†n ƒë∆∞·ªùng</li>
   <li><b>ü™ô Thu th·∫≠p Xu</b> - T√≠ch lu·ªπ ƒë·ªïi qu√† MoMo</li>
   <li><b>üß∫ M·ªói 5 Xu</b> nh·∫≠n <b>1 Gi·ªè C√°</b></li>
   <li><b>‚ö° C√†ng nhi·ªÅu Xu</b> ‚Üí T·ªëc ƒë·ªô c√†ng nhanh</li>
   <li><b>‚ùå Tr√°nh ch∆∞·ªõng ng·∫°i v·∫≠t</b> (ly, b·∫Øp ng√¥)</li>
   <li><b>üéÅ ƒê·∫°t 3 Gi·ªè C√°</b> ƒë·ªÉ nh·∫≠n Voucher MoMo</li>
  </ul>
  <button class="btn-momo" onclick="startGame()">üéÆ B·∫ÆT ƒê·∫¶U CH∆†I</button>
 </div>
</div>

<!-- CHARACTERS -->
<img id="but" src="assets/but.png" alt="√îng B·ª•t">
<img id="basketDrop" src="assets/basket.png" alt="Gi·ªè C√°">

<!-- HUD -->
<div id="hud">
 <div class="hud-item">
  <span class="hud-icon">üí∞</span>
  <span>Xu: <span id="coinEl" class="hud-value">0</span></span>
 </div>
 <div class="hud-item">
  <span class="hud-icon">üß∫</span>
  <span>Gi·ªè c√°: <span id="basketEl" class="hud-value">0</span></span>
 </div>
</div>

<!-- THANH PROGRESS -->
<div id="progressBox"><div id="progress"></div></div>

<!-- GAME OVER -->
<div id="over">
 <div id="over-content">
  <h2 style="color:#FFD700;font-size:36px;text-shadow:0 0 20px rgba(255,215,0,0.8);margin-bottom:30px;">‚ú®üßô‚Äç‚ôÇÔ∏è K·∫æT TH√öC</h2>
  
  <div id="summary">
   <div class="summary-item">
    <span>üí∞ XU THU ƒê∆Ø·ª¢C:</span>
    <span id="finalCoins" class="summary-value">0</span>
   </div>
   <div class="summary-item">
    <span>üß∫ GI·ªé C√Å:</span>
    <span id="finalBaskets" class="summary-value">0</span>
   </div>
   <div class="summary-item">
    <span>‚ö° T·ªêC ƒê·ªò CAO NH·∫§T:</span>
    <span id="finalSpeed" class="summary-value">0</span>
   </div>
  </div>

  <!-- VOUCHER POPUP - H√åNH ·∫¢NH FILL TO√ÄN B·ªò CONTAINER -->
  <div id="voucherPopup">
   <h3>üéâ CH√öC M·ª™NG!</h3>
   <p>B·∫°n ƒë√£ ƒë·∫°t ƒë·ªß <b>3 Gi·ªè C√°</b> üéØ</p>
   
   <div class="voucher-image-container">
     <img id="voucherImage" class="voucher-image" src="" alt="Voucher MoMo">
   </div>
   
   <div class="voucher-brand" id="voucherBrand"></div>
   <div class="voucher-value" id="voucherValue"></div>
   <div class="voucher-code" id="voucherCode">MOMO-TET-2026</div>
   
   <div class="voucher-desc" id="voucherDesc">
     S·ª≠ d·ª•ng m√£ trong v√≠ MoMo ƒë·ªÉ nh·∫≠n ∆∞u ƒë√£i ƒë·∫∑c bi·ªát! üßß
   </div>
   
   <small id="voucherExpiry">H·∫°n s·ª≠ d·ª•ng: 31/12/2026</small>
  </div>

  <div id="nameBox">
   <label>üè∑ NH·∫¨P T√äN C·ª¶A B·∫†N</label>
   <input id="playerName" placeholder="T√™n ng∆∞·ªùi ch∆°i">
   <button class="btn-momo" onclick="saveScore()">üíæ L∆ØU K·∫æT QU·∫¢</button>
  </div>

  <div id="leaderboard">
   <h3>üèÜ B·∫¢NG X·∫æP H·∫†NG</h3>
   <div id="rankList"></div>
  </div>

  <!-- N√öT CH∆†I L·∫†I -->
  <button class="btn-momo" id="playAgainBtn" onclick="location.reload()">üîÑ CH∆†I L·∫†I</button>
 </div>
</div>

<canvas id="game" width="360" height="640"></canvas>
</div>

<script>
/* ===== FULLSCREEN FIXES ===== */
// Fix 100vh tr√™n mobile
function setVH() {
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}

// Scale game cho ph√π h·ª£p
function initializeGameSize() {
  const gameWrapper = document.getElementById('gameWrapper');
  const windowWidth = window.innerWidth;
  const windowHeight = window.innerHeight;
  
  // T√≠nh to√°n t·ª∑ l·ªá scale
  const targetRatio = 360 / 640;
  const currentRatio = windowWidth / windowHeight;
  
  let scale;
  if (currentRatio > targetRatio) {
    // M√†n h√¨nh r·ªông h∆°n -> scale theo chi·ªÅu cao
    scale = windowHeight / 640;
  } else {
    // M√†n h√¨nh cao h∆°n -> scale theo chi·ªÅu r·ªông
    scale = windowWidth / 360;
  }
  
  // Gi·ªõi h·∫°n scale
  if (scale > 1.2) {
    scale = 1.2; // Gi·ªõi h·∫°n ph√≥ng to t·ªëi ƒëa 1.2x
  }
  
  if (scale < 0.8) {
    scale = 0.8; // Gi·ªõi h·∫°n thu nh·ªè t·ªëi thi·ªÉu 0.8x
  }
  
  gameWrapper.style.transform = `scale(${scale})`;
  gameWrapper.style.transformOrigin = 'center center';
}

// Fix ri√™ng cho intro
function fixIntroSize() {
  const startImg = document.getElementById('startImage');
  
  if (startImg) {
    // Reset ƒë·ªÉ ·∫£nh hi·ªÉn th·ªã ƒë√∫ng
    startImg.style.width = '100%';
    startImg.style.height = '100%';
    startImg.style.objectFit = 'cover';
    startImg.style.display = 'block';
  }
}

/* ===== INITIALIZE ===== */
window.addEventListener('load', function() {
  setVH();
  initializeGameSize();
  fixIntroSize();
  
  // Preload voucher images
  preloadVoucherImages();
  
  // Fix cho iOS
  setTimeout(() => {
    setVH();
    initializeGameSize();
    fixIntroSize();
  }, 100);
});

window.addEventListener('resize', function() {
  setVH();
  initializeGameSize();
  fixIntroSize();
});

window.addEventListener('orientationchange', function() {
  setTimeout(() => {
    setVH();
    initializeGameSize();
    fixIntroSize();
  }, 150);
});

// Prevent zoom on double tap
document.addEventListener('touchstart', function(e) {
  if (e.touches.length > 1) {
    e.preventDefault();
  }
}, { passive: false });

// Prevent context menu on long press
document.addEventListener('contextmenu', function(e) {
  e.preventDefault();
  return false;
});

/* ===== INTRO ‚Üí INSTRUCTION ===== */
function showInstruction(){
 document.getElementById('start').style.display = 'none';
 document.getElementById('instruction').style.display = 'flex';
 // B·∫Øt ƒë·∫ßu nh·∫°c n·ªÅn khi v√†o m√†n h√¨nh h∆∞·ªõng d·∫´n
 playBackgroundMusic();
}

/* ===== AUTO CLEAR ===== */
const GAME_VERSION = "premium-vouchers-10.0";
if(localStorage.getItem("game_version") !== GAME_VERSION){
 localStorage.removeItem("leaderboard");
 localStorage.setItem("game_version", GAME_VERSION);
}

/* ===== DANH S√ÅCH VOUCHER M·ªöI ===== */
const voucherList = [
  {
    id: 1,
    name: "Highlands Coffee",
    image: "assets/voucher/highlands.png",
    code: "HLD-MOMO-50K",
    brand: "HIGHLANDS COFFEE",
    value: "GI·∫¢M 30K",
    desc: "Gi·∫£m 30K cho h√≥a ƒë∆°n t·ª´ 100K",
    color: "#8B4513", // M√†u n√¢u cafe
    type: "portrait", // H√¨nh d·ªçc
    expiry: "31/03/2026",
    sticker: "CAFE ‚òï"
  },
  {
    id: 2,
    name: "Grab",
    image: "assets/voucher/grab.png",
    code: "GRAB-MOMO-50K",
    brand: "GRAB",
    value: "GI·∫¢M 40K",
    desc: "Gi·∫£m 50K cho chuy·∫øn xe Grab",
    color: "#00B14F", // M√†u xanh Grab
    type: "landscape", // H√¨nh ngang
    expiry: "31/03/2026",
    sticker: "XE üöó"
  },
  {
    id: 3,
    name: "GS25",
    image: "assets/voucher/gs25.png",
    code: "GS25-MOMO-25k",
    brand: "GS25",
    value: "GI·∫¢M 25k",
    desc: "Gi·∫£m 25k cho h√≥a ƒë∆°n t·ª´ 80K",
    color: "#FF6B00", // M√†u cam GS25
    type: "square", // H√¨nh vu√¥ng
    expiry: "31/03/2026",
    sticker: "TI·ªÜM üè™"
  },
  {
    id: 4,
    name: "CGV",
    image: "assets/voucher/cgv.png",
    code: "CGV-MOMO-2X1",
    brand: "CGV CINEMA",
    value: "MUA 1 T·∫∂NG 1",
    desc: "Mua 1 v√© t·∫∑ng 1 v√© xem phim",
    color: "#E31937", // M√†u ƒë·ªè CGV
    type: "landscape", // H√¨nh ngang
    expiry: "31/03/2026",
    sticker: "PHIM üé¨"
  },
  {
    id: 5,
    name: "Starbucks",
    image: "assets/voucher/starbucks.png",
    code: "SBUX-MOMO-50K",
    brand: "STARBUCKS",
    value: "GI·∫¢M 50K",
    desc: "Gi·∫£m 50K cho h√≥a ƒë∆°n t·ª´ 150K",
    color: "#00704A", // M√†u xanh Starbucks
    type: "portrait", // H√¨nh d·ªçc
    expiry: "31/03/2026",
    sticker: "VIP üåü"
  },
  {
    id: 6,
    name: "Beauty Box",
    image: "assets/voucher/beautybox.png",
    code: "BBOX-MOMO-25%",
    brand: "BEAUTY BOX",
    value: "GI·∫¢M 25%",
    desc: "Gi·∫£m 25% cho s·∫£n ph·∫©m l√†m ƒë·∫πp",
    color: "#FF69B4", // M√†u h·ªìng
    type: "square", // H√¨nh vu√¥ng
    expiry: "31/12/2026",
    sticker: "ƒê·∫∏P üíÑ"
  }
];

// Preload voucher images
function preloadVoucherImages() {
  console.log('ƒêang t·∫£i h√¨nh ·∫£nh voucher...');
  
  voucherList.forEach(voucher => {
    const img = new Image();
    img.src = voucher.image;
    img.onload = () => {
      console.log(`‚úì ƒê√£ t·∫£i: ${voucher.image}`);
    };
    img.onerror = () => {
      console.warn(`‚ö† Kh√¥ng th·ªÉ t·∫£i: ${voucher.image}`);
      // Fallback image b·∫±ng SVG
      voucher.image = createFallbackSVG(voucher);
    };
  });
}

// T·∫°o h√¨nh SVG fallback cho voucher
function createFallbackSVG(voucher) {
  const svg = `
    <svg width="300" height="220" viewBox="0 0 300 220" xmlns="http://www.w3.org/2000/svg">
      <rect width="300" height="220" rx="15" fill="white"/>
      <rect x="10" y="10" width="280" height="200" rx="10" fill="${voucher.color}20" stroke="${voucher.color}" stroke-width="2"/>
      <text x="150" y="80" font-family="Arial" font-size="24" font-weight="bold" fill="${voucher.color}" text-anchor="middle">
        ${voucher.brand}
      </text>
      <text x="150" y="120" font-family="Arial" font-size="20" fill="${voucher.color}" text-anchor="middle">
        ${voucher.value}
      </text>
      <rect x="80" y="150" width="140" height="40" rx="15" fill="${voucher.color}"/>
      <text x="150" y="175" font-family="Arial" font-size="16" fill="white" text-anchor="middle">
        ${voucher.sticker}
      </text>
    </svg>
  `;
  return "data:image/svg+xml;base64," + btoa(svg);
}

// H√†m ch·ªçn voucher ng·∫´u nhi√™n
function getRandomVoucher() {
  const randomIndex = Math.floor(Math.random() * voucherList.length);
  return voucherList[randomIndex];
}

// H√†m hi·ªÉn th·ªã voucher - H√åNH ·∫¢NH FILL TO√ÄN B·ªò CONTAINER
function showVoucher() {
  const voucher = getRandomVoucher();
  const voucherPopup = document.getElementById('voucherPopup');
  const voucherImage = document.getElementById('voucherImage');
  const voucherCode = document.getElementById('voucherCode');
  const voucherDesc = document.getElementById('voucherDesc');
  const voucherExpiry = document.getElementById('voucherExpiry');
  const voucherBrand = document.getElementById('voucherBrand');
  const voucherValue = document.getElementById('voucherValue');
  
  // Hi·ªÉn th·ªã h√¨nh ·∫£nh voucher - fill to√†n b·ªô container
  voucherImage.onload = function() {
    // ƒê·∫£m b·∫£o h√¨nh ·∫£nh fill container
    this.style.width = '100%';
    this.style.height = '100%';
    this.style.objectFit = 'cover';
  };
  
  voucherImage.src = voucher.image;
  voucherImage.alt = voucher.name;
  voucherImage.className = 'voucher-image'; // Ch·ªâ c·∫ßn class c∆° b·∫£n
  
  // Hi·ªÉn th·ªã th√¥ng tin voucher
  voucherBrand.textContent = voucher.brand;
  voucherValue.textContent = voucher.value;
  voucherCode.textContent = voucher.code;
  voucherDesc.textContent = voucher.desc;
  voucherExpiry.textContent = `H·∫°n s·ª≠ d·ª•ng: ${voucher.expiry}`;
  
  // Th√™m hi·ªáu ·ª©ng m√†u
  voucherCode.style.background = `linear-gradient(135deg, ${voucher.color}20 0%, ${voucher.color}40 100%)`;
  voucherCode.style.borderColor = voucher.color;
  voucherCode.style.color = voucher.color;
  
  voucherValue.style.background = `linear-gradient(90deg, ${voucher.color}, ${voucher.color}E6)`;
  voucherValue.style.color = 'white';
  
  voucherBrand.style.color = voucher.color;
  voucherBrand.style.textShadow = `0 2px 10px ${voucher.color}40`;
  
  // Th√™m hi·ªáu ·ª©ng √°nh s√°ng cho h√¨nh ·∫£nh
  voucherImage.style.animation = 'float 3s ease-in-out infinite';
  
  // Th√™m hi·ªáu ·ª©ng shine cho gi√° tr·ªã voucher
  voucherValue.style.background = `linear-gradient(90deg, 
    ${voucher.color}00, ${voucher.color}, ${voucher.color}00, ${voucher.color}, ${voucher.color}00)`;
  voucherValue.style.backgroundSize = '200% 100%';
  voucherValue.style.animation = 'shine 3s linear infinite';
  
  // Hi·ªÉn th·ªã popup
  voucherPopup.style.display = 'block';
  
  console.log(`ƒê√£ ch·ªçn voucher: ${voucher.name} (fill container)`);
}

/* ===== CANVAS SETUP ===== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

canvas.width = 360;
canvas.height = 640;

/* ===== IMAGES ===== */
const roadImg = new Image(); 
roadImg.src = "assets/road.png";

const playerImg = new Image(); 
playerImg.src = "assets/cotam-run.png";

const coinImg = new Image(); 
coinImg.src = "assets/coin.png";

const obstacleTypes = [
 { img: new Image(), size: 40, color: '#8B4513' },
 { img: new Image(), size: 44, color: '#654321' },
 { img: new Image(), size: 38, color: '#808080' }
];
obstacleTypes[0].img.src = "assets/obs-rock.png";
obstacleTypes[1].img.src = "assets/obs-log.png";
obstacleTypes[2].img.src = "assets/obs-pot.png";

const imagesToLoad = [roadImg, playerImg, coinImg, 
                     obstacleTypes[0].img, obstacleTypes[1].img, obstacleTypes[2].img];

/* ===== √ÇM THANH ===== */
// Nh·∫°c n·ªÅn
const bgMusic = new Audio();
bgMusic.src = "assets/background.mp3";
bgMusic.loop = true;
bgMusic.volume = 0.5;

// Hi·ªáu ·ª©ng √¢m thanh
const sCoin = new Audio("assets/coin.mp3");
const sBasket = new Audio("assets/basket.mp3");
const sHit = new Audio("assets/hit.mp3");
const sClick = new Audio("assets/click.mp3");
const sSpeedUp = new Audio("assets/speedup.mp3");
const sBut = new Audio("assets/but.mp3");
const sMagic = new Audio("assets/magic.mp3");
const sWin = new Audio("assets/win.mp3");

// Thi·∫øt l·∫≠p volume
sCoin.volume = 0.3;
sBasket.volume = 0.4;
sHit.volume = 0.5;
sClick.volume = 0.3;
sSpeedUp.volume = 0.4;
sBut.volume = 0.6;
sMagic.volume = 0.5;
sWin.volume = 0.6;

// Bi·∫øn ki·ªÉm so√°t √¢m thanh
let soundEnabled = true;

// H√†m ph√°t nh·∫°c n·ªÅn
function playBackgroundMusic() {
  if (soundEnabled && bgMusic) {
    bgMusic.play().catch(e => {
      console.log("Nh·∫°c n·ªÅn c·∫ßn t∆∞∆°ng t√°c ng∆∞·ªùi d√πng:", e);
      // Th·ª≠ l·∫°i khi ng∆∞·ªùi d√πng click
      document.addEventListener('click', function playOnce() {
      bgMusic.play().catch(e => console.log("V·∫´n kh√¥ng th·ªÉ ph√°t nh·∫°c n·ªÅn"));
        document.removeEventListener('click', playOnce);
      }, { once: true });
    });
  }
}

// H√†m d·ª´ng nh·∫°c n·ªÅn
function stopBackgroundMusic() {
  if (bgMusic) {
    bgMusic.pause();
    bgMusic.currentTime = 0;
  }
}

// H√†m b·∫≠t/t·∫Øt √¢m thanh
function toggleSound() {
  soundEnabled = !soundEnabled;
  
  // C·∫≠p nh·∫≠t icon
  const soundIcon = document.getElementById('soundIcon');
  soundIcon.textContent = soundEnabled ? 'üîä' : 'üîá';
  
  // Ph√°t √¢m thanh click khi b·∫≠t/t·∫Øt
  if (soundEnabled) {
    playSound(sClick);
  }
  
  // √Åp d·ª•ng tr·∫°ng th√°i √¢m thanh
  if (soundEnabled) {
    bgMusic.volume = 0.5;
    sCoin.volume = 0.3;
    sBasket.volume = 0.4;
    sHit.volume = 0.5;
    sClick.volume = 0.3;
    sSpeedUp.volume = 0.4;
    sBut.volume = 0.6;
    sMagic.volume = 0.5;
    sWin.volume = 0.6;
    
    // Ti·∫øp t·ª•c nh·∫°c n·ªÅn n·∫øu ƒëang trong game
    if (run) {
      playBackgroundMusic();
    }
  } else {
    bgMusic.volume = 0;
    sCoin.volume = 0;
    sBasket.volume = 0;
    sHit.volume = 0;
    sClick.volume = 0;
    sSpeedUp.volume = 0;
    sBut.volume = 0;
    sMagic.volume = 0;
    sWin.volume = 0;
  }
}

// H√†m ph√°t √¢m thanh an to√†n
function playSound(sound) {
  if (!soundEnabled || !sound) return;
  
  try {
    // N·∫øu √¢m thanh ƒëang ph√°t, reset ƒë·ªÉ ph√°t l·∫°i
    sound.currentTime = 0;
    sound.play().catch(e => {
      // N·∫øu l·ªói, th·ª≠ t·∫£i l·∫°i file
      console.log("L·ªói √¢m thanh, th·ª≠ t·∫£i l·∫°i:", e);
      sound.load();
    });
  } catch (e) {
    console.log("Kh√¥ng th·ªÉ ph√°t √¢m thanh:", e);
  }
}

// H√†m ph√°t √¢m thanh √¥ng B·ª•t v·ªõi hi·ªáu ·ª©ng ƒë·∫∑c bi·ªát
function playButSound() {
  if (!soundEnabled) return;
  
  // Ph√°t √¢m thanh √¥ng B·ª•t
  playSound(sBut);
  
  // Sau 0.5 gi√¢y, ph√°t √¢m thanh ph√©p thu·∫≠t
  setTimeout(() => {
    playSound(sMagic);
  }, 500);
  
  // T·∫°o hi·ªáu ·ª©ng l·∫•p l√°nh khi √¥ng B·ª•t xu·∫•t hi·ªán
  createSparkleEffect();
}

// H√†m t·∫°o hi·ªáu ·ª©ng l·∫•p l√°nh
function createSparkleEffect() {
  const butElement = document.getElementById('but');
  const butRect = butElement.getBoundingClientRect();
  const gameWrapper = document.getElementById('gameWrapper');
  const wrapperRect = gameWrapper.getBoundingClientRect();
  
  // V·ªã tr√≠ √¥ng B·ª•t
  const butX = butRect.left - wrapperRect.left + butRect.width / 2;
  const butY = butRect.top - wrapperRect.top;
  
  // T·∫°o 10 h·∫°t l·∫•p l√°nh
  for (let i = 0; i < 10; i++) {
    const sparkle = document.createElement('div');
    sparkle.style.position = 'absolute';
    sparkle.style.width = '10px';
    sparkle.style.height = '10px';
    sparkle.style.background = 'radial-gradient(circle, #FFD700, #FF9100)';
    sparkle.style.borderRadius = '50%';
    sparkle.style.left = (butX - 5) + 'px';
    sparkle.style.top = (butY + 50) + 'px'; // D∆∞·ªõi ch√¢n √¥ng B·ª•t
    sparkle.style.zIndex = '14';
    sparkle.style.pointerEvents = 'none';
    sparkle.style.animation = `sparkle 1s ease-out forwards`;
    sparkle.style.animationDelay = (i * 0.1) + 's';
    
    // Random direction
    const angle = Math.random() * Math.PI * 2;
    const distance = 30 + Math.random() * 50;
    const endX = Math.cos(angle) * distance;
    const endY = Math.sin(angle) * distance - 50;
    
    sparkle.style.setProperty('--end-x', endX + 'px');
    sparkle.style.setProperty('--end-y', endY + 'px');
    
    gameWrapper.appendChild(sparkle);
    
    // X√≥a sau khi animation k·∫øt th√∫c
    setTimeout(() => {
      if (sparkle.parentNode) {
        sparkle.parentNode.removeChild(sparkle);
      }
    }, 1000 + i * 100);
  }
}

// Unlock audio tr√™n mobile
document.addEventListener('touchstart', function() {
  const silentAudio = new Audio();
  silentAudio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==';
  silentAudio.play().then(() => {
    console.log("Audio ƒë√£ ƒë∆∞·ª£c m·ªü kh√≥a");
  }).catch(e => console.log("Audio unlock error"));
}, { once: true });

/* ===== GAME STATE ===== */
let run = false, coin = 0, basket = 0;
let baseSpeed = 3.5, speed = baseSpeed, speedStep = 0.7, maxSpeed = 9;
let roadY = 0;
const lanes = [60, 180, 300];
let player = { lane: 1, y: 520 };
let coins = [], obstacles = [];
let coinTimer = 0, obstacleTimer = 0;
let frameCount = 0;
let butTimeout = null;
let lastMilestone = 0;

/* SPRITE ANIMATION */
const RUN_FRAMES = 4;
let runFrame = 0, runTick = 0;
let SW = 0, SH = 0;
playerImg.onload = () => {
 SW = playerImg.width / RUN_FRAMES;
 SH = playerImg.height;
};

/* ===== NH√ÇN V·∫¨T L·ªöN H∆†N ===== */
const PLAYER_WIDTH = 55;
const PLAYER_HEIGHT = 82;
const PLAYER_OFFSET_X = PLAYER_WIDTH / 2;
const PLAYER_OFFSET_Y = 60;

/* ===== T·ªêI ∆ØU HI·ªÜU SU·∫§T ===== */
// Th√™m bi·∫øn ƒë·ªÉ ki·ªÉm so√°t FPS
let lastTime = 0;
const targetFPS = 60;
const frameInterval = 1000 / targetFPS;

// Object pooling cho coins v√† obstacles ƒë·ªÉ t√°i s·ª≠ d·ª•ng
const coinPool = [];
const obstaclePool = [];

// T·∫°o s·∫µn object pool
function initializeObjectPools() {
  // T·∫°o s·∫µn 20 coin objects
  for (let i = 0; i < 20; i++) {
    coinPool.push({
      lane: 0,
      y: 0,
      angle: 0,
      scale: 1,
      pulse: 0,
      active: false
    });
  }
  
  // T·∫°o s·∫µn 15 obstacle objects
  for (let i = 0; i < 15; i++) {
    obstaclePool.push({
      lane: 0,
      y: 0,
      type: 0,
      phase: 0,
      shakeIntensity: 0,
      shakeSpeed: 0,
      rotation: 0,
      scale: 1,
      spawnTime: 0,
      active: false
    });
  }
}

// L·∫•y coin t·ª´ pool
function getCoinFromPool() {
  for (let i = 0; i < coinPool.length; i++) {
    if (!coinPool[i].active) {
      coinPool[i].active = true;
      return coinPool[i];
    }
  }
  
  // N·∫øu h·∫øt, t·∫°o th√™m
  const newCoin = {
    lane: 0,
    y: 0,
    angle: 0,
    scale: 1,
    pulse: 0,
    active: true
  };
  coinPool.push(newCoin);
  return newCoin;
}

// L·∫•y obstacle t·ª´ pool
function getObstacleFromPool() {
  for (let i = 0; i < obstaclePool.length; i++) {
    if (!obstaclePool[i].active) {
      obstaclePool[i].active = true;
      return obstaclePool[i];
    }
  }
  
  // N·∫øu h·∫øt, t·∫°o th√™m
  const newObstacle = {
    lane: 0,
    y: 0,
    type: 0,
    phase: 0,
    shakeIntensity: 0,
    shakeSpeed: 0,
    rotation: 0,
    scale: 1,
    spawnTime: 0,
    active: true
  };
  obstaclePool.push(newObstacle);
  return newObstacle;
}

// H√†m spawn coin t·ªëi ∆∞u
const spawnCoin = () => {
  const lane = Math.floor(Math.random() * 3);
  const coinObj = getCoinFromPool();
  
  coinObj.lane = lane;
  coinObj.y = -40;
  coinObj.angle = Math.random() * Math.PI * 2;
  coinObj.scale = 0.8 + Math.random() * 0.4;
  coinObj.pulse = Math.random() * Math.PI * 2;
  coinObj.active = true;
  
  coins.push(coinObj);
};

// H√†m spawn obstacle t·ªëi ∆∞u
const spawnObstacleWave = () => {
  const freeLane = Math.floor(Math.random() * 3);
  for(let l = 0; l < 3; l++) {
    if(l !== freeLane && Math.random() < 0.7) {
      const type = Math.floor(Math.random() * obstacleTypes.length);
      const obstacle = getObstacleFromPool();
      
      obstacle.lane = l;
      obstacle.y = -60;
      obstacle.type = type;
      obstacle.phase = Math.random() * Math.PI * 2;
      obstacle.shakeIntensity = 1 + Math.random() * 2;
      obstacle.shakeSpeed = 0.08 + Math.random() * 0.15;
      obstacle.rotation = Math.random() * 0.3 - 0.15;
      obstacle.scale = 1.4 + Math.random() * 0.2;
      obstacle.spawnTime = frameCount;
      obstacle.active = true;
      
      obstacles.push(obstacle);
    }
  }
};

// H√†m ki·ªÉm tra v√† x√≥a v·∫≠t th·ªÉ kh√¥ng c·∫ßn thi·∫øt
function cleanupObjects() {
  // X√≥a coins ƒë√£ ra kh·ªèi m√†n h√¨nh v√† ƒë√°nh d·∫•u kh√¥ng active
  for (let i = coins.length - 1; i >= 0; i--) {
    if (coins[i].y > 700) { // Ra kh·ªèi m√†n h√¨nh
      coins[i].active = false;
      coins.splice(i, 1);
    }
  }
  
  // X√≥a obstacles ƒë√£ ra kh·ªèi m√†n h√¨nh
  for (let i = obstacles.length - 1; i >= 0; i--) {
    if (obstacles[i].y > 700) { // Ra kh·ªèi m√†n h√¨nh
      obstacles[i].active = false;
      obstacles.splice(i, 1);
    }
  }
}

/* ===== START GAME ===== */
function startGame(){
 playSound(sClick);
 document.getElementById('instruction').style.display = 'none';
 run = true;
 lastMilestone = 0;
 
 // Kh·ªüi t·∫°o object pools
 initializeObjectPools();
 
 // TƒÉng t·ªëc ƒë·ªô nh·∫°c n·ªÅn khi b·∫Øt ƒë·∫ßu game
 if (bgMusic) {
   bgMusic.playbackRate = 1.0;
 }
 
 lastTime = performance.now();
 loop();
}

/* CONTROL - T·ªëi ∆∞u touch */
let touchStartX = 0;
let touchStartTime = 0;
const TAP_THRESHOLD = 200; // ms
const SWIPE_THRESHOLD = 50; // pixels

canvas.addEventListener("touchstart", function(e) {
 e.preventDefault();
 const touch = e.touches[0];
 const rect = canvas.getBoundingClientRect();
 touchStartX = touch.clientX - rect.left;
 touchStartTime = Date.now();
});

canvas.addEventListener("touchend", function(e) {
 e.preventDefault();
 const touchEndTime = Date.now();
 const touchDuration = touchEndTime - touchStartTime;
 
 if (touchDuration < TAP_THRESHOLD) {
   const rect = canvas.getBoundingClientRect();
   const touchEndX = e.changedTouches[0].clientX - rect.left;
   const swipeDistance = touchEndX - touchStartX;
   
   const oldLane = player.lane;
   
   if (Math.abs(swipeDistance) > SWIPE_THRESHOLD) {
     // Swipe r√µ r√†ng
     if (swipeDistance > 0) {
       // Swipe sang ph·∫£i
       player.lane = Math.min(2, player.lane + 1);
     } else {
       // Swipe sang tr√°i
       player.lane = Math.max(0, player.lane - 1);
     }
   } else {
     // Tap ƒë∆°n gi·∫£n
     const halfWidth = rect.width / 2;
     if (touchEndX < halfWidth) {
       player.lane = Math.max(0, player.lane - 1);
     } else {
       player.lane = Math.min(2, player.lane + 1);
     }
   }
   
   // Ph√°t √¢m thanh khi chuy·ªÉn lane
   if (oldLane !== player.lane) {
     playSound(sClick);
   }
 }
});

/* MAIN GAME LOOP - T·ªêI ∆ØU */
function loop(timestamp = 0){
 if(!run) return;
 
 // ƒêi·ªÅu ch·ªânh FPS ƒë·ªÉ game ch·∫°y m∆∞·ª£t h∆°n
 const elapsed = timestamp - lastTime;
 
 if (elapsed < frameInterval) {
   requestAnimationFrame(loop);
   return;
 }
 
 lastTime = timestamp - (elapsed % frameInterval);
 
 frameCount++;
 
 ctx.clearRect(0, 0, 360, 640);
 
 /* DRAW ROAD - T·ªëi ∆∞u b·∫±ng c√°ch ch·ªâ v·∫Ω 1 l·∫ßn */
 roadY += speed;
 if(roadY >= 640) roadY = 0;
 
 // T·∫°o gradient n·ªÅn ƒë·ªÉ gi·∫£m vi·ªác v·∫Ω ·∫£nh
 const gradient = ctx.createLinearGradient(0, 0, 0, 640);
 gradient.addColorStop(0, '#1a0033');
 gradient.addColorStop(0.5, '#330066');
 gradient.addColorStop(1, '#4d0099');
 ctx.fillStyle = gradient;
 ctx.fillRect(0, 0, 360, 640);
 
 // V·∫Ω road v·ªõi hi·ªáu ·ª©ng m·ªù
 ctx.globalAlpha = 0.8;
 ctx.drawImage(roadImg, 0, roadY - 640, 360, 640);
 ctx.drawImage(roadImg, 0, roadY, 360, 640);
 ctx.globalAlpha = 1.0;
 
 /* DRAW LANE MARKERS - ƒê∆°n gi·∫£n h√≥a */
 ctx.strokeStyle = 'rgba(255, 215, 0, 0.2)';
 ctx.lineWidth = 1;
 for(let i = 0; i < lanes.length; i++) {
  ctx.beginPath();
  ctx.moveTo(lanes[i] - 60, 0);
  ctx.lineTo(lanes[i] - 60, 640);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(lanes[i] + 60, 0);
  ctx.lineTo(lanes[i] + 60, 640);
  ctx.stroke();
 }
 
 /* DRAW PLAYER - T·ªëi ∆∞u animation */
 runTick++;
 if(runTick % 8 === 0) runFrame = (runFrame + 1) % RUN_FRAMES; // Gi·∫£m t·ªëc ƒë·ªô animation
 
 if(SW){
  // V·∫Ω b√≥ng ƒë∆°n gi·∫£n
  ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
  ctx.beginPath();
  ctx.ellipse(
    lanes[player.lane],
    player.y + 10,
    PLAYER_WIDTH * 0.4,
    PLAYER_WIDTH * 0.15,
    0, 0, Math.PI * 2
  );
  ctx.fill();
  
  // V·∫Ω nh√¢n v·∫≠t v·ªõi k√≠ch th∆∞·ªõc m·ªõi
  ctx.drawImage(
   playerImg,
   runFrame * SW, 0, SW, SH,
   lanes[player.lane] - PLAYER_OFFSET_X, 
   player.y - PLAYER_OFFSET_Y, 
   PLAYER_WIDTH, 
   PLAYER_HEIGHT
  );
 }
 
 /* DRAW COINS - T·ªëi ∆∞u */
 for(let i = coins.length - 1; i >= 0; i--){
  const c = coins[i];
  c.y += speed;
  c.angle += 0.08; // Gi·∫£m t·ªëc ƒë·ªô xoay
  c.pulse += 0.08; // Gi·∫£m t·ªëc ƒë·ªô pulse
  
  const pulseScale = 0.1 * Math.sin(c.pulse);
  
  ctx.save();
  ctx.translate(lanes[c.lane], c.y);
  ctx.rotate(c.angle);
  ctx.scale(c.scale + pulseScale, c.scale + pulseScale);
  
  // Gi·∫£m hi·ªáu ·ª©ng shadow ƒë·ªÉ tƒÉng hi·ªáu su·∫•t
  ctx.shadowColor = '#FFD700';
  ctx.shadowBlur = 10;
  ctx.drawImage(coinImg, -15, -15, 30, 30);
  ctx.restore();
  
  const collisionDistance = 45;
  
  if(c.lane === player.lane && Math.abs(c.y - player.y) < collisionDistance){
   coins.splice(i, 1);
   c.active = false; // ƒê√°nh d·∫•u coin kh√¥ng active
   coin++;
   document.getElementById('coinEl').innerText = coin;
   
   playSound(sCoin);
   
   // THAY ƒê·ªîI T·ª™ 50 XU XU·ªêNG 5 XU CHO M·ªñI GI·ªé C√Å
   const milestone = Math.floor(coin / 5); // ƒê√£ thay ƒë·ªïi t·ª´ 50 xu·ªëng 5
   if(milestone > basket){
    basket = milestone;
    document.getElementById('basketEl').innerText = basket;
    
    // PH√ÅT √ÇM THANH √îNG B·ª§T KHI NH·∫¨N GI·ªé C√Å M·ªöI
    playButSound();
    
    // Hi·ªÉn th·ªã √¥ng B·ª•t
    const butElement = document.getElementById('but');
    butElement.classList.add('show');
    
    if (butTimeout) {
      clearTimeout(butTimeout);
    }
    
    butTimeout = setTimeout(() => {
      butElement.classList.add('hide');
      setTimeout(() => {
        butElement.classList.remove('show', 'hide');
        butElement.style.top = '-200px';
        butElement.style.opacity = '0';
      }, 500);
    }, 2000);
    
    // Hi·ªÉn th·ªã gi·ªè c√°
    const basketElement = document.getElementById('basketDrop');
    basketElement.classList.add('show');
    
    setTimeout(() => {
      basketElement.classList.remove('show');
      basketElement.style.opacity = '0';
      basketElement.style.transform = 'translateX(-50%) scale(0)';
    }, 1000);
   }
   
   // TƒÉng t·ªëc ƒë·ªô
   const oldSpeed = speed;
   speed = Math.min(baseSpeed + milestone * speedStep, maxSpeed);
   
   // Ph√°t √¢m thanh tƒÉng t·ªëc n·∫øu c√≥ s·ª± thay ƒë·ªïi t·ªëc ƒë·ªô v√† milestone m·ªõi
   if (milestone > lastMilestone) {
     lastMilestone = milestone;
     playSound(sSpeedUp);
     
     // TƒÉng t·ªëc ƒë·ªô nh·∫°c n·ªÅn theo t·ªëc ƒë·ªô game
     if (bgMusic) {
       const musicSpeed = 1.0 + (speed - baseSpeed) / (maxSpeed - baseSpeed) * 0.3;
       bgMusic.playbackRate = Math.min(musicSpeed, 1.3);
     }
   }
   
   // THAY ƒê·ªîI THANH PROGRESS T·ª™ 50 XU XU·ªêNG 5 XU
   document.getElementById('progress').style.width = ((coin % 5) / 5 * 100) + "%"; // ƒê√£ thay ƒë·ªïi t·ª´ 50 xu·ªëng 5
  }
 }
 
 /* DRAW OBSTACLES - T·ªëi ∆∞u */
 for(let i = obstacles.length - 1; i >= 0; i--){
  const o = obstacles[i];
  const t = obstacleTypes[o.type];
  o.y += speed;
  o.phase += o.shakeSpeed * 0.8; // Gi·∫£m t·ªëc ƒë·ªô rung
  
  const shakeX = Math.sin(o.phase) * o.shakeIntensity;
  
  const age = frameCount - o.spawnTime;
  const blink = age < 60 ? (Math.sin(age * 0.3) * 0.5 + 0.5) : 1;
  
  ctx.save();
  ctx.translate(lanes[o.lane] + shakeX, o.y);
  ctx.rotate(o.rotation);
  ctx.scale(o.scale, o.scale);
  ctx.globalAlpha = blink;
  
  // Gi·∫£m hi·ªáu ·ª©ng shadow
  ctx.shadowColor = t.color;
  ctx.shadowBlur = 8;
  ctx.drawImage(t.img, -t.size/2, -t.size/2, t.size, t.size);
  ctx.restore();
  
  const collisionDistance = 40;
  
  if(o.lane === player.lane && Math.abs(o.y - player.y) < collisionDistance){
   endGame(); 
   return;
  }
 }
 
 // D·ªçn d·∫πp v·∫≠t th·ªÉ kh√¥ng c·∫ßn thi·∫øt
 cleanupObjects();
 
 coinTimer++; 
 obstacleTimer++;
 
 // ƒêi·ªÅu ch·ªânh spawn rate d·ª±a tr√™n t·ªëc ƒë·ªô
 const coinSpawnRate = Math.max(15, 30 - Math.floor(speed));
 const obstacleSpawnRate = Math.max(50, 100 - Math.floor(speed * 5));
 
 if(coinTimer > coinSpawnRate && coins.length < 10){
  spawnCoin(); 
  coinTimer = 0;
 }
 
 if(obstacleTimer > obstacleSpawnRate && obstacles.length < 8){
  spawnObstacleWave(); 
  obstacleTimer = 0;
 }
 
 requestAnimationFrame(loop);
}

function endGame(){
 run = false;
 playSound(sHit);
 stopBackgroundMusic();
 
 document.getElementById('finalCoins').textContent = coin;
 document.getElementById('finalBaskets').textContent = basket;
 document.getElementById('finalSpeed').textContent = speed.toFixed(1);
 
 const butElement = document.getElementById('but');
 if (butElement.classList.contains('show')) {
   butElement.classList.remove('show');
   butElement.classList.add('hide');
   setTimeout(() => {
     butElement.classList.remove('hide');
     butElement.style.top = '-200px';
     butElement.style.opacity = '0';
   }, 500);
 }
 
 if (butTimeout) {
   clearTimeout(butTimeout);
   butTimeout = null;
 }
 
 const gameWrapper = document.getElementById('gameWrapper');
 gameWrapper.style.animation = 'shake 0.5s ease';
 setTimeout(() => {
  gameWrapper.style.animation = '';
 }, 500);
 
 setTimeout(() => {
  document.getElementById('over').style.display = 'flex';
  
  if(basket >= 3){
   // Hi·ªÉn th·ªã voucher ng·∫´u nhi√™n
   showVoucher();
   // Ph√°t √¢m thanh chi·∫øn th·∫Øng
   playSound(sWin);
  }
 }, 1000);
}

/* SAVE SCORE */
function saveScore(){
 const name = document.getElementById('playerName').value.trim() || "Ng∆∞·ªùi Ch∆°i";
 let lb = JSON.parse(localStorage.getItem("leaderboard") || "[]");
 
 lb.push({
  name, 
  coin,
  basket,
  speed: speed.toFixed(1),
  date: new Date().toLocaleDateString('vi-VN')
 });
 
 lb.sort((a, b) => b.coin - a.coin);
 
 lb = lb.slice(0, 8);
 
 localStorage.setItem("leaderboard", JSON.stringify(lb));
 
 document.getElementById('nameBox').style.display = 'none';
 document.getElementById('leaderboard').style.display = 'block';
 
 document.getElementById('playAgainBtn').style.display = 'block';
 
 const rankList = document.getElementById('rankList');
 rankList.innerHTML = '';
 
 // Header
 const header = document.createElement('div');
 header.className = 'rank';
 header.style.background = 'rgba(255, 215, 0, 0.3)';
 header.style.fontWeight = 'bold';
 header.innerHTML = `
  <span>T√äN</span>
  <span>XU</span>
  <span>GI·ªé</span>
 `;
 rankList.appendChild(header);
 
 // Ranks
 lb.forEach((r, i) => {
  const rankDiv = document.createElement('div');
  rankDiv.className = `rank ${r.name === name && r.coin === coin ? 'you' : ''}`;
  
  let medal = '';
  if(i === 0) medal = 'ü•á';
  else if(i === 1) medal = 'ü•à';
  else if(i === 2) medal = 'ü•â';
  
  rankDiv.innerHTML = `
   <span>${medal} ${r.name}</span>
   <span>üí∞ ${r.coin}</span>
   <span>üß∫ ${r.basket}</span>
  `;
  rankList.appendChild(rankDiv);
 });
}

// Th√™m animation cho sparkle effect
const style = document.createElement('style');
style.textContent = `
@keyframes sparkle {
  0% {
    transform: translate(0, 0) rotate(0deg) scale(0);
    opacity: 0;
  }
  20% {
    transform: translate(var(--end-x, 0), var(--end-y, -50px)) rotate(90deg) scale(1);
    opacity: 1;
  }
  80% {
    opacity: 0.7;
  }
  100% {
    transform: translate(calc(var(--end-x, 0) * 1.5), calc(var(--end-y, -50px) - 50px)) rotate(180deg) scale(0);
    opacity: 0;
  }
}
`;
document.head.appendChild(style);
</script>
</body>
</html>
